
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>MINERA√á√ÉO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    :root {
      --gap: 10px;
      --shadow: 0 2px 6px rgba(0,0,0,0.25);
      --z-search: 3000;
      --z-layers: 2200;
      --z-north: 2100;
      --z-title: 2000;
      --z-legend: 1600;
      --z-coords: 1500;
    }

    * { font-family: Arial, sans-serif !important; box-sizing: border-box; }

    html, body {
      margin: 0; padding: 0; height: 100%; width: 100%;
      overflow: hidden;
    }

    #map { position: absolute; inset: 0; width: 100% !important; height: 100% !important; }

    /* T√≠tulo */
    .map-title {
      position: fixed; top: var(--gap); left: var(--gap);
      background: rgba(255,255,255,0.9); padding: 6px 10px; border-radius: 6px;
      font-size: 1rem; font-weight: bold; color: #333; box-shadow: var(--shadow);
      z-index: var(--z-title); max-width: 45vw; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    /* Coordenadas */
    #coords {
      position: fixed; left: var(--gap); bottom: calc(100px + var(--gap));
      background: rgba(255,255,255,0.8); padding: 6px 8px; font-size: 13px; border-radius: 4px;
      border: 1px solid rgba(204,204,204,0.6); z-index: var(--z-coords); box-shadow: var(--shadow);
    }

    /* Busca */
    #searchContainer {
      position: fixed; top: var(--gap); right: var(--gap); display: flex; align-items: center;
      z-index: var(--z-search); width: 44px; height: 42px; overflow: hidden; background: white;
      border-radius: 40px; border: 1px solid #ccc; box-shadow: var(--shadow);
    }
    #searchToggle { background: none; border: none; cursor: pointer; font-size: 1.15rem; padding: 0 10px; height: 42px; }
    #searchMunicipio { flex: 1; border: none; outline: none; font-size: 1rem; padding: 0 10px; height: 42px; display: none; min-width: 0; }
    #searchContainer.expanded { width: 300px; overflow: visible; }
    #searchContainer.expanded #searchMunicipio { display: block; }

    /* Remover contornos Leaflet / popup clean */
    .leaflet-container .leaflet-interactive:focus,
    .leaflet-container .leaflet-marker-icon:focus,
    .leaflet-container .leaflet-popup-close-button:focus { outline: none !important; box-shadow: none !important; }
    .leaflet-popup-content-wrapper, .leaflet-popup-tip { box-shadow: none !important; border: none !important; }

    /* Dropdown da busca */
    #listaMunicipios {
      position: absolute; top: 100%; left: 0; width: 100%; max-height: 280px; overflow-y: auto;
      background: white; border: 1px solid #ccc; border-top: none; border-radius: 0 0 12px 12px;
      box-shadow: var(--shadow); display: none; font-size: 14px; z-index: var(--z-search);
    }
    #listaMunicipios div { padding: 8px 10px; cursor: pointer; border-bottom: 1px solid #eee; }
    #listaMunicipios div:hover { background: #f2f2f2; }
    #listaMunicipios div.highlighted { background: #007bff; color: #fff; }

    /* Painel de camadas embrulhado */
    #camadasWrapper {
      position: fixed; top: 56px !important; right: var(--gap); left: auto;
      z-index: var(--z-layers); background: white; border: 1px solid #ccc; border-radius: 6px;
      overflow: hidden; box-shadow: var(--shadow); max-width: min(92vw, 520px);
    }
    #camadasHeader { background: #007bff; color: #fff; padding: 6px 12px; font-weight: bold; font-size: 14px; cursor: pointer; user-select: none; }
    .leaflet-control-layers { margin: 0 !important; padding: 6px !important; max-height: 50vh; overflow: auto; border: none !important; box-shadow: none !important; }
    .leaflet-control-layers.collapsed-panel { display: none !important; }

    /* Legenda Territ√≥rios */
    .legend {
      position: fixed; bottom:100px; left: 70%; transform: translateX(-50%);
      background: white; line-height: 18px; color: #333; padding: 12px; font-size: 14px; border-radius: 6px;
      max-width: min(92vw, 420px); max-height: 40vh; overflow-y: auto; box-shadow: var(--shadow);
      transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease; z-index: var(--z-legend);
    }
    .legend-toggle {
      position: fixed; bottom: calc(var(--gap) + 48px); left: 70%; transform: translateX(-50%);
      display: block; background: #007bff; color: white; border: none; padding: 6px 14px; border-radius: 20px; font-size: 14px; cursor: pointer;
      z-index: var(--z-legend); box-shadow: var(--shadow);
    }
    .legend.collapsed { max-height: 0 !important; padding: 0 !important; overflow: hidden; opacity: 0; }
    .legend-toggle.attention { animation: pulseAttention 2.5s infinite ease-in-out; }
    @keyframes pulseAttention { 0%{transform: translateX(-50%) scale(1); background:#007bff;} 50%{transform: translateX(-50%) scale(1.06); background:#0056b3;} 100%{transform: translateX(-50%) scale(1); background:#007bff;} }

    /* Seta norte no topo direito */
    .north-arrow {
      pointer-events: none;
      background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/7/7f/Map_symbol_north_arrow.svg/64px-Map_symbol_north_arrow.svg.png');
      background-size: contain; background-repeat: no-repeat; width: 40px; height: 40px; opacity: 0.85; margin: 0;
    }
    .leaflet-top.leaflet-right { top: 60px !important; right: var(--gap) !important; }

    /* Upload */
    #uploadBtn {
      position: fixed; top: 45px; left: var(--gap); right: auto;
      background: white; padding: 6px 10px; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; z-index: var(--z-search); box-shadow: var(--shadow);
    }
    #uploadInput { display: none; }

    /* Rosa dos ventos SBG */
    .rosa-sbg { position: fixed; left: var(--gap); bottom: var(--gap); width: 140px; height: 140px; transform: scale(0.6); transform-origin: bottom left; pointer-events: none; z-index: 1400; }

    /* Popup dimens√µes */
    .leaflet-popup-content { max-width: 300px; max-height: 180px; overflow-y: auto; font-size: 13.5px; line-height: 1.3; }
    .leaflet-popup-content-wrapper { padding: 8px; }
    .leaflet-pane.leaflet-popup-pane { z-index: 5000 !important; }

    .leaflet-top.leaflet-left { top: 66px; left: var(--gap); display: flex; flex-direction: column; gap: 8px; }

    #creditosLegenda {
      position: fixed; bottom: 18px; left: 70%; transform: translateX(-50%);
      background: white; padding: 3px 3px; font-size:7px; border-radius: 3px;
      box-shadow: 0 2px2px rgba(0,0,0,0.25); display:flex; align-items:center; justify-content:center; text-align:center; z-index: 2000; line-height: 1.4;
    }

    .my-location-dot{ width:14px; height:14px; background:#4285F4; border:2px solid #fff; border-radius:50%; box-shadow: 0 0 0 6px rgba(66,133,244,.25), 0 2px 6px rgba(0,0,0,.35); }

    /* Mobile */
    @media (max-width: 768px) {
      #searchContainer { right: var(--gap); left: auto; transform: none; top: var(--gap); width: 44px; }
      #searchContainer.expanded { width: min(92vw, 420px); }
      #camadasWrapper { top: 100px; max-width: min(92vw, 520px); }
      .leaflet-control-layers { max-height: 38vh; }
      #coords { bottom: calc(100px + var(--gap)); font-size: 12px; }
      .rosa-sbg { width: 120px; height: 120px; }
    }

.legend-mineracao{
  max-height: 40vh;        /* j√° est√° no JS, mas pode manter aqui tamb√©m */
  overflow-y: auto;        /* garante a barra */
  -webkit-overflow-scrolling: touch; /* momentum scrolling no iOS/Android */
  touch-action: pan-y;     /* permite arrastar verticalmente sem conflitar com o mapa */
}
    .legend-mineracao { z-index: var(--z-legend); }
@media (max-width: 768px) {
  .legend-mineracao { font-size: 13px; }
}

/* --- Legenda Minera√ß√£o: expans√≠vel --- */
.legend-mineracao { position: relative; }
.legend-mineracao .miner-header{
  display:flex; align-items:center; gap:8px;
  font-weight:bold; cursor:pointer; user-select:none;
  padding:6px 8px; margin:-6px -6px 8px -6px; /* encosta nas bordas do card */
  border-bottom:1px solid #eee;
}
.legend-mineracao .miner-header .arrow{
  transition: transform .25s ease;
  display:inline-block; width:0; height:0;
  border-left:6px solid transparent;
  border-right:6px solid transparent;
  border-top:8px solid #333;
}
.legend-mineracao.expanded .miner-header .arrow{ transform: rotate(180deg); }

.legend-mineracao .miner-body{ display:none; }
.legend-mineracao.expanded .miner-body{ display:block; }

/* melhora toque/rolagem dentro do corpo */
.legend-mineracao .miner-body{
  max-height: 40vh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  touch-action: pan-y;
}

  </style>
</head>
<body>
  <div id="map"></div>

  <div class="map-title">MINERA√á√ÉO</div>
  <div id="coords">Lat: -, Lon: -<br>E: -, N: -<br>Fuso: -</div>

  <button id="uploadBtn">Upload KML</button>
  <input type="file" id="uploadInput" accept=".kml,.kmz,.xml" multiple />

  <!-- Busca -->
  <div id="searchContainer">
    <button id="searchToggle">üîç</button>
    <input type="text" id="searchMunicipio" placeholder="Pesquisar munic√≠pio" />
    <div id="listaMunicipios"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <script src="https://unpkg.com/shp-write/shpwrite.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-ajax/dist/leaflet.ajax.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tokml@0.4.0/tokml.js"></script>
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>

  <script>
    const map = L.map('map').setView([-7, -42], 7.48);

    // Localiza√ß√£o (sem zoom autom√°tico)
    let geoMarker = null;
    const myLocIcon = L.divIcon({ className: '', html: '<div class="my-location-dot"></div>', iconSize: [18,18], iconAnchor: [9,9] });
    function onLocationFound(e){
      const latlng = e.latlng;
      if (!geoMarker){ geoMarker = L.marker(latlng, { icon: myLocIcon, pane: 'markerPane', interactive:false }).addTo(map); }
      else { geoMarker.setLatLng(latlng); }
    }
    function onLocationError(err){ console.warn('Erro localiza√ß√£o:', err.message); }
    map.on('locationfound', onLocationFound);
    map.on('locationerror', onLocationError);
    map.locate({ watch:true, setView:false, enableHighAccuracy:true, maxZoom:17 });

    // Panes (sem energia e sem transmiss√£o)
    map.createPane('pane-mask');        map.getPane('pane-mask').style.zIndex = 200;
    map.createPane('pane-base');        map.getPane('pane-base').style.zIndex = 300;
    map.createPane('pane-piaui');       map.getPane('pane-piaui').style.zIndex = 360;
    map.createPane('pane-biomas');      map.getPane('pane-biomas').style.zIndex = 370;
    map.createPane('pane-territorios'); map.getPane('pane-territorios').style.zIndex = 410;
    map.createPane('pane-municipios');  map.getPane('pane-municipios').style.zIndex = 420;
    map.createPane('pane-imperial');    map.getPane('pane-imperial').style.zIndex = 500;
    map.createPane('pane-litigio');     map.getPane('pane-litigio').style.zIndex = 550;
    map.createPane('pane-upload');      map.getPane('pane-upload').style.zIndex = 6000;

    // Pane Litologia (entre biomas e hidrografia)
    map.createPane('pane-litologia');
    map.getPane('pane-litologia').style.zIndex = 565; // abaixo da hidrografia

    // Panes Hidrografia
    map.createPane('pane-hidros-rios');    map.getPane('pane-hidros-rios').style.zIndex = 575;
    map.createPane('pane-hidros-massas');  map.getPane('pane-hidros-massas').style.zIndex = 574;
// Pane Ferrovias (acima de todas as outras camadas vetoriais)
map.createPane('pane-ferrovias');
map.getPane('pane-ferrovias').style.zIndex = 650; // > minera√ß√£o (580), hidrografia (574-575), litologia (565) etc.
map.getPane('pane-ferrovias').style.pointerEvents = 'auto';

// === Panes UCs ===
map.createPane('pane-uc-federal');   map.getPane('pane-uc-federal').style.zIndex = 590;
map.createPane('pane-uc-estadual');  map.getPane('pane-uc-estadual').style.zIndex = 590;


    // Pane Minera√ß√£o (acima da hidrografia)
     map.createPane('pane-mineracao');
    map.getPane('pane-mineracao').style.zIndex = 580;

    // Popup autoPan ajustado
    L.Popup.prototype.options.autoPan = true;
    L.Popup.prototype.options.autoPanPaddingTopLeft = L.point(10, 90);
    L.Popup.prototype.options.autoPanPaddingBottomRight = L.point(10, 40);

    L.control.scale().addTo(map);

    // Zoom e seta norte
    map.zoomControl.remove();
    L.control.zoom({ position: 'topleft' }).addTo(map);
    const north = L.control({position: "topright"});
    north.onAdd = ()=> L.DomUtil.create("div", "north-arrow");
    north.addTo(map);

    // Basemaps
    const osmLayer    = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors' }).addTo(map);
    const esriSat     = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles ¬© Esri' });
    const esriTerrain = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles ¬© Esri' });
    const esriRoad    = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles ¬© Esri' });

    /* === Territ√≥rios: cores e popup === */
    const territorioPalette = ['#1f78b4','#33a02c','#e31a1c','#ff7f00','#6a3d9a','#b15928','#a6cee3','#b2df8a','#fb9a99','#fdbf6f','#cab2d6','#ffff99'];
    const territorioColors = []; let colorIndex = 0;
    function getColorForTerritorio(nome, codigo = null) {
      let terr = territorioColors.find(t => t.nome === nome);
      if (!terr) {
        const display = codigo ? `TD ${codigo} ‚Äì ${nome}` : nome;
        terr = { nome, codigo, label: display, cor: territorioPalette[colorIndex % territorioPalette.length] };
        territorioColors.push(terr); colorIndex++;
      }
      return terr.cor;
    }

    function formatNumeroPTBR(n, d=2){return n.toLocaleString('pt-BR',{minimumFractionDigits:d,maximumFractionDigits:d});}
    function generateInfoContent(p){
      const labels = {
        NM_MUN:"Munic√≠pio:",CD_MUN:"C√≥digo do Munic√≠pio:",fid:"C√≥digo do Territ√≥rio:",
        NM_TD:"Territ√≥rio de Desenvolvimento:",AREA_KM2:"√Årea (km¬≤):",
        "Aglomerado - PI":"Aglomerado:",pib_porcent_Piaui:"PIB (%) Piau√≠:",pop_porcent_Piaui:"Popula√ß√£o (%) Piau√≠:",
        pib_porcent_TD:"PIB (%) TD:",pop_porcent_TD:"Popula√ß√£o (%) TD:",
        pib_2021:"PIB 2021:",pop_censo2022:"Popula√ß√£o (Censo 2022):",densidade_demografica:"Densidade demogr√°fica:"
      };
      const grupos = {
        geografico:["NM_MUN","CD_MUN","fid","NM_TD","Aglomerado - PI","AREA_KM2"],
        populacional:["pop_censo2022","densidade_demografica","pop_porcent_Piaui","pop_porcent_TD"],
        pib:["pib_2021","pib_porcent_Piaui","pib_porcent_TD"]
      };
      function formatValor(key,val){
        if(val===null||val===undefined) return "-";
        const num = Number(val);
        if(!isNaN(num)){
          if(["pib_porcent_Piaui","pop_porcent_Piaui","pib_porcent_TD","pop_porcent_TD"].includes(key)) return num.toFixed(2).replace('.',',')+"%";
          if(key==="CD_MUN") return String(Math.trunc(num));
          if(key==="pop_censo2022") return num.toLocaleString('pt-BR',{maximumFractionDigits:0});
          if(key==="pib_2021") return formatNumeroPTBR(num * 1000, 2);
          return formatNumeroPTBR(num,2);
        }
        return val;
      }
      function tabela(titulo,campos){
        let h = `<div style="text-align:center;font-weight:bold;font-size:1.05em;margin:10px 0;">${titulo}</div><table style="border-collapse:collapse;width:100%;font-size:.95em;">`;
        campos.forEach(k=>{
          if(k in p){
            h+=`<tr><th style="text-align:left;padding:6px 8px;border-bottom:1px solid #ddd;font-weight:normal;">${labels[k]||k}</th><td style="text-align:right;padding:6px 8px;border-bottom:1px solid #ddd;">${formatValor(k,p[k])}</td></tr>`;
          }
        });
        return h+="</table>";
      }
      return tabela("Informa√ß√µes Geogr√°ficas",grupos.geografico)+tabela("Informa√ß√µes Populacionais",grupos.populacional)+tabela("Informa√ß√µes de PIB",grupos.pib);
    }

    function highlightFeature(e){ e.target.setStyle({ weight:4, color:'#ff6600', fillColor:'#ff6600', fillOpacity:0.5 }); e.target.bringToFront(); }
    let municipioSelecionado = null;
    function resetHighlight(e){ if (municipioSelecionado !== e.target) municipiosLayer.resetStyle(e.target); }

    function onEachMunicipio(feature, layer){
      const nome = feature.properties.NM_MUN || "Munic√≠pio";
      layer.bindTooltip(`<b>${nome}</b><br><i>Clique para mais informa√ß√µes</i>`, { sticky:false, direction:'top', opacity:0.9 });
      layer.on("popupopen", ()=>layer.closeTooltip());
      layer.on({ mouseover: highlightFeature, mouseout: resetHighlight });
      layer.on("click", ()=>{
        if (municipioSelecionado && municipioSelecionado !== layer) municipiosLayer.resetStyle(municipioSelecionado);
        municipioSelecionado = layer;
        layer.setStyle({ weight:4, color:'#ff6600', fillColor:'#ff6600', fillOpacity:0.5 });
      });

      if (feature.properties) {
        layer.bindPopup(
          generateInfoContent(feature.properties)+
          `<button class="download-btn" style="margin-top:5px;">Baixar KML deste munic√≠pio</button>`
        );
        layer.on('popupopen', (e)=>{
          const popupEl = e.popup.getElement();
          const btn = popupEl.querySelector('.download-btn');
          if (btn) btn.addEventListener('click', ()=>{
            const nomeArquivo = (feature.properties?.NM_MUN || "municipio")
              .normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/√ß/g,"c").replace(/√á/g,"C")
              .replace(/[^\w\s-]/g,"").replace(/\s+/g,"_");
            let kml = tokml({ type:"FeatureCollection", features:[feature] });
            const estiloKML = `
              <Style id="customStyle">
                <LineStyle><color>ff0000ff</color><width>2</width></LineStyle>
                <PolyStyle><color>00ff0000</color><fill>1</fill><outline>1</outline></PolyStyle>
              </Style>`;
            kml = kml.replace("</Document>", `${estiloKML}</Document>`).replace(/<Placemark>/g,'<Placemark><styleUrl>#customStyle</styleUrl>');
            const blob = new Blob([kml], { type:"application/vnd.google-earth.kml+xml" });
            const url = URL.createObjectURL(blob); const a = document.createElement("a");
            a.href = url; a.download = `${nomeArquivo}.kml`; a.click(); URL.revokeObjectURL(url);
          });
        });
      }
    }

    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape" && municipioSelecionado) {
        municipioSelecionado.closePopup();
        municipiosLayer.resetStyle(municipioSelecionado);
        municipioSelecionado = null;
      }
    });

    // Territ√≥rios
    function styleTerritorios(f){
      const nome = f.properties.NM_TD || "Territ√≥rio";
      const codigo = f.properties.fid || "";
      const cor = getColorForTerritorio(nome,codigo);
      return { color: cor, weight: 2, fillColor: cor, fillOpacity: 0.4 };
    }
    let territorioSelecionado = null;
    function onEachTerritorio(feature, layer){
      layer.on({
        mouseover: highlightFeature,
        mouseout: (e)=>territoriosLayer.resetStyle(e.target),
        click: function (e) {
          L.DomEvent.stop(e);
          const territorioNome  = feature.properties?.NM_TD;
          const territorioCodigo = feature.properties?.fid;

          // Estat√≠sticas agregadas se existirem
          const tdKey   = String(territorioCodigo ?? territorioNome);
          const tdStats = (typeof territoryStats !== 'undefined') ? territoryStats.get(tdKey) : null;

          function fmt(n, d=2){ const v = Number(n); if (!Number.isFinite(v)) return '-'; return v.toLocaleString('pt-BR', { minimumFractionDigits:d, maximumFractionDigits:d }); }

          let totaisHtml = '';
          if (tdStats) {
            const pibExibicao = tdStats.pib * 1000;
            totaisHtml =
              `<hr><b>Totais do Territ√≥rio</b>
               <table style="border-collapse:collapse;width:100%;font-size:.95em;margin-top:6px;">
                 <tr><th style="text-align:left;padding:6px 8px;border-bottom:1px solid #ddd;font-weight:normal;">Popula√ß√£o (Censo 2022)</th><td style="text-align:right;padding:6px 8px;border-bottom:1px solid #ddd;">${fmt(tdStats.pop,0)}</td></tr>
                 <tr><th style="text-align:left;padding:6px 8px;border-bottom:1px solid #ddd;font-weight:normal;">PIB 2021 (R$)</th><td style="text-align:right;padding:6px 8px;border-bottom:1px solid #ddd;">${fmt(pibExibicao,2)}</td></tr>
                 <tr><th style="text-align:left;padding:6px 8px;border-bottom:1px solid #ddd;font-weight:normal;">Popula√ß√£o (% do Piau√≠)</th><td style="text-align:right;padding:6px 8px;border-bottom:1px solid #ddd;">${fmt(tdStats.pop_pct_piaui,2)}%</td></tr>
                 <tr><th style="text-align:left;padding:6px 8px;border-bottom:1px solid #ddd;font-weight:normal;">PIB (% do Piau√≠)</th><td style="text-align:right;padding:6px 8px;border-bottom:1px solid #ddd;">${fmt(tdStats.pib_pct_piaui,2)}%</td></tr>
               </table>`;
          }

          // Lista de munic√≠pios do territ√≥rio
          const municipios = [];
          municipiosLayer.eachLayer(mLayer=>{
            const p = mLayer.feature?.properties || {};
            if ((p.NM_TD && territorioNome && p.NM_TD === territorioNome) ||
                (p.fid && territorioCodigo && p.fid === territorioCodigo)) {
              municipios.push(p.NM_MUN || "(sem nome)");
            }
          });
          municipios.sort((a,b)=>a.localeCompare(b,'pt-BR'));

          const baseHtml =
            `<b>Territ√≥rio:</b> ${territorioNome || "-"}<br>`+
            `<b>C√≥digo:</b> ${territorioCodigo || "-"}<br>`+
            `<button class="download-btn" style="margin-top:5px;">Baixar KML deste territ√≥rio</button>` +
            totaisHtml;

          const listaHtml = municipios.length
            ? `<hr><b>Munic√≠pios (${municipios.length}):</b>
               <div style="max-height:150px;overflow:auto;margin-top:6px;">
                 <ul style="margin:0;padding-left:18px;">${municipios.map(n=>`<li>${n}</li>`).join('')}</ul>
               </div>`
            : `<hr><i>Nenhum munic√≠pio associado encontrado.</i>`;

          layer.bindPopup(baseHtml + listaHtml);

          layer.once('popupopen', (ev)=>{
            const popupEl = ev.popup.getElement();
            const btn = popupEl.querySelector('.download-btn');
            if (!btn) return;
            btn.addEventListener('click', (ev2)=>{
              ev2.stopPropagation();
              if (typeof tokml !== 'function') { alert('Erro: biblioteca tokml n√£o carregada.'); return; }
              const nomeArquivo = (layer.feature.properties?.NM_TD || "territorio")
                .normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s-]/g,"").replace(/\s+/g,"_");
              let kml = tokml({ type:"FeatureCollection", features:[layer.feature] });
              const estiloKML = `
                <Style id="customStyle">
                  <LineStyle><color>ff00ffff</color><width>5</width></LineStyle>
                  <PolyStyle><color>00ffffff</color><fill>1</fill><outline>1</outline></PolyStyle>
                </Style>`;
              kml = kml.replace("</Document>", `${estiloKML}</Document>`).replace(/<Placemark>/g,'<Placemark><styleUrl>#customStyle</styleUrl>');
              const blob = new Blob([kml], { type:"application/vnd.google-earth.kml+xml" });
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a"); a.href = url; a.download = `${nomeArquivo}.kml`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
            });
          });

          layer.openPopup();
        }
      });
    }

    const territoriosLayer = new L.GeoJSON.AJAX("territorios.geojson", { pane: 'pane-territorios', style: styleTerritorios, onEachFeature: onEachTerritorio });

    // Limpar sele√ß√£o geral ao clicar fora
    map.on("click", function (e) {
      const t = e.originalEvent?.target;
      if (t && (t.classList?.contains('leaflet-interactive') || t.closest?.('.leaflet-interactive'))) return;

      territorioSelecionado = null;
      territoriosLayer.eachLayer(layer => { territoriosLayer.resetStyle(layer); });

      if (municipioSelecionado) { municipiosLayer.resetStyle(municipioSelecionado); municipioSelecionado = null; }
      map.closePopup();

      const legendDiv = document.querySelector('.legend');
      const toggleBtn = document.querySelector('.legend-toggle');
      if (legendDiv && toggleBtn && !legendDiv.classList.contains('collapsed')) {
        legendDiv.classList.add('collapsed');
        toggleBtn.textContent = 'Selecionar  territ√≥rios';
        toggleBtn.classList.remove('attention');
      }
    });

    // Fallback para legenda
    setTimeout(() => { if (!document.querySelector('.legend-toggle')) addLegend(); }, 2000);

    const municipiosLayer = new L.GeoJSON.AJAX("municipios.geojson", {
      pane: 'pane-municipios',
      style: ()=>({ color:'#000', weight:1.5, fillOpacity:0 }),
      onEachFeature: onEachMunicipio
    }).addTo(map);

    // Agrega√ß√µes TD
    const territoryStats = new Map();
    const stateTotals = { pop: 0, pib: 0 };
    function num(n){ const v = Number(n); return Number.isFinite(v) ? v : 0; }
    municipiosLayer.on('data:loaded', () => {
      territoryStats.clear(); stateTotals.pop = 0; stateTotals.pib = 0;
      municipiosLayer.eachLayer(layer => {
        const p = layer?.feature?.properties || {};
        const nomeTD = p.NM_TD || '(sem territ√≥rio)';
        const codTD  = p.fid ?? p.CD_TD ?? nomeTD;
        const pop = num(p.pop_censo2022);
        const pib = num(p.pib_2021);
        stateTotals.pop += pop; stateTotals.pib += pib;
        const key = String(codTD);
        const cur = territoryStats.get(key) || { codigo: codTD, nome: nomeTD, pop: 0, pib: 0 };
        cur.pop += pop; cur.pib += pib; territoryStats.set(key, cur);
      });
      for (const [key, td] of territoryStats.entries()) {
        td.pop_pct_piaui = stateTotals.pop ? (td.pop / stateTotals.pop) * 100 : 0;
        td.pib_pct_piaui = stateTotals.pib ? (td.pib / stateTotals.pib) * 100 : 0;
        territoryStats.set(key, td);
      }
    });

    /* === Lit√≠gio === */
    function onEachLitigio(feature, layer){
      layer.on({ mouseover: highlightFeature, mouseout: e=>litigioLayer.resetStyle(e.target) });
      layer.bindPopup(`<b>Lit√≠gio</b><br><div style="margin-top:5px;"><button class="download-btn" data-format="kml">Baixar KML</button></div>`);
      layer.on("popupopen", ()=>{
        const btn = document.querySelector(".download-btn");
        if (btn) btn.onclick = ()=>{
          let kml = tokml({ type:"FeatureCollection", features:[feature] });
          const estiloKML = `
            <Style id="litigioStyle">
              <LineStyle><color>ff00ff00</color><width>3</width></LineStyle>
              <PolyStyle><color>00ffffff</color><fill>1</fill><outline>1</outline></PolyStyle>
            </Style>`;
          kml = kml.replace("</Document>", `${estiloKML}</Document>`).replace(/<Placemark>/g,'<Placemark><styleUrl>#litigioStyle</styleUrl>');
          const blob = new Blob([kml], { type:"application/vnd.google-earth.kml+xml" });
          const url = URL.createObjectURL(blob); const a = document.createElement("a");
          a.href = url; a.download = "litigio.kml"; a.click(); URL.revokeObjectURL(url);
        };
      });
    }
    const litigioLayer = new L.GeoJSON.AJAX("litigio.geojson", { pane: 'pane-litigio', style:{ color:'red', weight:2 }, onEachFeature: onEachLitigio }).addTo(map);

    /* === Linha Imperial === */
    function onEachImperial(feature, layer){
      layer.on({ mouseover: highlightFeature, mouseout: e=>linhaImperialLayer.resetStyle(e.target) });
      layer.bindPopup(`<b>Linha Imperial</b><br><button class="download-btn" style="margin-top:5px;">Baixar KML</button>`);
      layer.on("popupopen", ()=>{
        const btn = document.querySelector(".download-btn");
        if (btn) btn.onclick = ()=>{
          let kml = tokml({ type:"FeatureCollection", features:[feature] });
          const estiloKML = `
            <Style id="imperialStyle">
              <LineStyle><color>ff00a5ff</color><width>3</width></LineStyle>
              <PolyStyle><color>00ffffff</color><fill>1</fill><outline>1</outline></PolyStyle>
            </Style>`;
          kml = kml.replace("</Document>", `${estiloKML}</Document>`).replace(/<Placemark>/g,'<Placemark><styleUrl>#imperialStyle</styleUrl>');
          const blob = new Blob([kml], { type:"application/vnd.google-earth.kml+xml" });
          const url = URL.createObjectURL(blob); const a = document.createElement("a");
          a.href = url; a.download = "linha_imperial.kml"; a.click(); URL.revokeObjectURL(url);
        };
      });
    }
    const linhaImperialLayer = new L.GeoJSON.AJAX("linha_imperial.geojson", { pane: 'pane-imperial', style:{ color:'blue', weight:2, dashArray:'5,5' }, onEachFeature: onEachImperial }).addTo(map);

    /* === Controle de camadas === */
    const baseMaps = {
      "OpenStreetMap": osmLayer,
      "Esri Sat√©lite": esriSat,
      "Esri Terrain": esriTerrain,
      "Esri Road": esriRoad
    };
    const overlayMaps = {
      "Territ√≥rios": territoriosLayer,
      "Munic√≠pios": municipiosLayer,
      "Lit√≠gio": litigioLayer,
      "Linha Imperial": linhaImperialLayer
    };
    const layersControl = L.control.layers(baseMaps, overlayMaps, { collapsed:false, position:'topleft' }).addTo(map);

    // HIDROGRAFIA
    const COLOR_RIO  = '#00A8F6';
    function nomeHidrografia(props = {}, fallback = 'Hidrografia'){
      const key = ['NOME','Nome','name','Rio','RIO','Curso','Hidrografia','Corpo','Corpo_dagua','Corpo_Dagua']
        .find(k => Object.keys(props).some(p => p.toLowerCase() === k.toLowerCase()));
      return key ? props[key] : fallback;
    }


// --- CORRE√á√ÉO DE CODIFICA√á√ÉO (para nomes com √É¬Å, √É¬©, √É¬≥, etc.) ---
function repairMojibake(s){
  if (s == null) return s;
  try { return decodeURIComponent(escape(String(s))); }
  catch(_) { return String(s); }
}
/* ==== UNIDADES DE CONSERVA√á√ÉO: helpers ==== */
function ucGetNome(props = {}){
  // tenta primeiro v√°rias chaves comuns em bases federais/estaduais
  let v = pickProp(props, [
    'nome','NOME','Name','NAME',
    'nm_uc','NM_UC','nome_uc','NOME_UC','no_uc','NO_UC',
    'ds_nome','DS_NOME','ds_nome_uc','DS_NOME_UC',
    'uc','UC','nm','NM','descricao','DESCRICAO','descri√ß√£o','DESCRI√á√ÉO'
  ]);

  // fallback heur√≠stico: qualquer chave que tenha "nome" e ("uc" ou "unidade")
  if (v == null || String(v).trim() === '') {
    const dyn = Object.keys(props).find(k =>
      /nome/i.test(k) && (/\buc\b/i.test(k) || /unidade/i.test(k))
    );
    if (dyn) v = props[dyn];
  }

  const nome = repairMojibake(v);
  return (nome && String(nome).trim()) ? String(nome).trim() : 'Unidade de Conserva√ß√£o';
}

function ucGetCategoria(props = {}){
  return repairMojibake(
    pickProp(props, ['categoria','CATEGORIA','categoria_uc','CAT','tipo','TIPO','grupo','GRUPO'])
  ) || '-';
}

function ucGetAto(props = {}){
  return repairMojibake(
    pickProp(props, ['ato','ato_criacao','ATO_CRIACAO','ato_cria√ß√£o','ATO','fundamento','FUNDAMENTO'])
  ) || '-';
}
function ucGetArea(props = {}){
  // tenta ha, sen√£o tenta m¬≤ e converte
  let ha = pickProp(props, ['area_ha','√°rea_ha','AREA_HA','ha','HA']);
  if (ha == null){
    const m2 = pickProp(props, ['area_m2','√°rea_m2','AREA_M2','m2']);
    if (m2 != null) ha = Number(m2)/10000;
  }
  if (ha == null){
    // tenta km¬≤
    const km2 = pickProp(props, ['area_km2','√°rea_km2','AREA_KM2','km2','KM2']);
    if (km2 != null) ha = Number(km2)*100;
  }
  if (!Number.isFinite(Number(ha))) return '-';
  return Number(ha).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function styleUC(feature, isFederal){
  // tons verdes; federal um pouco mais escuro
  const fill = isFederal ? '#2e7d32' : '#43a047';
  return {
    color: '#1b5e20',
    weight: 1.5,
    fillColor: fill,
    fillOpacity: 0.28,
    pane: isFederal ? 'pane-uc-federal' : 'pane-uc-estadual'
  };
}
function hoverUCEnter(e){
  const l=e.target;
  l.setStyle({ weight:3, fillOpacity:0.5 });
  try{ l.bringToFront(); }catch(_){}
}
function hoverUCLeave(e){
  const l=e.target;
  if (l.options && l.options._baseStyle) l.setStyle(l.options._baseStyle);
}

function bindUCPopup(feature, layer, esfera){
  const p = feature.properties || {};
  const nome = ucGetNome(p);
  const cat  = ucGetCategoria(p);
  const ato  = ucGetAto(p);
  const area = ucGetArea(p);

  const rows = [
    ['Categoria', cat],
    ['√Årea (ha)', area],
    ['Ato de cria√ß√£o', ato]
  ].map(([k,v])=>`
    <tr>
      <th style="text-align:left;padding:6px 8px;border-bottom:1px solid #ddd;font-weight:bold;">${k}</th>
      <td style="text-align:right;padding:6px 8px;border-bottom:1px solid #ddd;">${v ?? '-'}</td>
    </tr>`).join('');

  const html = `
  <div style="font-weight:bold;margin-bottom:6px;">${esfera} ‚Ä¢ ${nome}</div>
  <table style="border-collapse:collapse;width:100%;font-size:.95em;">${rows}</table>
  <div style="margin-top:8px;"><b>Atributos completos</b></div>
  ${buildPropsTableAll(p)}
  <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
   <button class="uc-kml-btn">Baixar KML</button>
  </div>`;
layer.bindPopup(html);

  layer.on('popupopen', (e)=>{
    const el = e.popup.getElement();
    const btn = el.querySelector('.uc-kml-btn');
    if (!btn) return;
    btn.addEventListener('click', ()=>{
      const nomeArq = (nome || 'UC')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^\w\s-]/g,'').replace(/\s+/g,'_');

      let kml = tokml({ type:'FeatureCollection', features:[feature] });
      const estiloKML = `
        <Style id="ucStyle">
          <LineStyle><color>ff1b5e20</color><width>2</width></LineStyle>
          <PolyStyle><color>8043a047</color><fill>1</fill><outline>1</outline></PolyStyle>
        </Style>`;
      kml = kml.replace('</Document>', `${estiloKML}</Document>`)
               .replace(/<Placemark>/g, '<Placemark><styleUrl>#ucStyle</styleUrl>');

      const blob = new Blob([kml], { type:'application/vnd.google-earth.kml+xml' });
      const url  = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `${nomeArq}.kml`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
  });

  // tooltip leve com o nome
  try { layer.bindTooltip(nome, { direction:'top', opacity:0.9, sticky:false }); } catch(_){}
}


    // Rios (linhas)
    function styleRios(feature){ return { color: COLOR_RIO, weight: 2.8, opacity: 0.95, lineCap: 'round', lineJoin: 'round' }; }
    function hoverRio(e){ const l=e.target; l.setStyle({ color:'#01579B', weight:6, opacity:1 }); try{ l.bringToFront(); }catch(_){} }
    function resetHoverRio(e){ const l=e.target; l.setStyle(l.options._baseStyle || {}); }

    function styleMassas(feature){ return { color:'#0D47A1', weight:1.8, opacity:0.95, fillColor:'#1565C0', fillOpacity:0.40 }; }
    function hoverMassa(e){ const l=e.target; l.setStyle({ color:'#0B3D91', weight:3.2, opacity:1, fillOpacity:0.70 }); try{ l.bringToFront(); }catch(_){} }
    function resetHoverMassa(e){ const l=e.target; l.setStyle(l.options._baseStyle || {}); }

    function hydroPopup(feature, layer, tipo){
      const p = feature.properties || {};
      const nome = p.NORIOCOMP || (tipo === 'rio' ? 'Rio sem nome' : "Massa d'√°gua");
      const codigo = p.CORIO || '';
      const titulo = (tipo === 'rio') ? 'Rio' : "Massa d'√°gua";

      let linhas = '';
      if (p.NORIOCOMP !== undefined) {
        linhas += `<tr><th style="text-align:left;padding:4px;border-bottom:1px solid #eee;font-weight:bold;">Nome do Rio</th><td style="text-align:right;padding:4px;border-bottom:1px solid #eee;">${nome}</td></tr>`;
      }
      if (p.CORIO !== undefined) {
        linhas += `<tr><th style="text-align:left;padding:4px;border-bottom:1px solid #eee;font-weight:bold;">C√≥digo</th><td style="text-align:right;padding:4px;border-bottom:1px solid #eee;">${codigo}</td></tr>`;
      }
      Object.keys(p).sort().forEach(k => {
        if (k.toUpperCase() === 'NORIOCOMP' || k.toUpperCase() === 'CORIO') return;
        linhas += `<tr><th style="text-align:left;padding:4px;border-bottom:1px solid #eee;font-weight:normal;">${k}</th><td style="text-align:right;padding:4px;border-bottom:1px solid #eee;">${(p[k] ?? '').toString()}</td></tr>`;
      });

      const html = `
        <div style="font-weight:bold;margin-bottom:6px;">${titulo}</div>
        <table style="border-collapse:collapse;width:100%;font-size:.95em;">${linhas || '<tr><td>(Sem atributos)</td></tr>'}</table>
        <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
          <button class="hidro-kml-btn" style="padding:6px 10px;border:1px solid #ccc;border-radius:6px;background:#fff;cursor:pointer;">Baixar KML</button>
        </div>`;
      layer.bindPopup(html);

      layer.on('popupopen', (e)=>{
        const el = e.popup.getElement();
        const btn = el.querySelector('.hidro-kml-btn');
        if (!btn) return;
        btn.addEventListener('click', ()=>{
          const nomeArq = String(nome).normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^\w\s-]/g,'').replace(/\s+/g,'_') || (tipo==='rio' ? 'rio' : 'massa_dagua');
          let kml = tokml({ type:'FeatureCollection', features:[feature] });
          const estiloKML = (tipo === 'rio')
            ? `<Style id="rioStyle"><LineStyle><color>fff7c34f</color><width>4</width></LineStyle></Style>`
            : `<Style id="massaStyle"><LineStyle><color>ff1047a1</color><width>2</width></LineStyle><PolyStyle><color>801565c0</color><fill>1</fill><outline>1</outline></PolyStyle></Style>`;
          kml = kml.replace('</Document>', `${estiloKML}</Document>`)
                   .replace(/<Placemark>/g, `<Placemark><styleUrl>#${tipo==='rio' ? 'rioStyle' : 'massaStyle'}</styleUrl>`);
          const blob = new Blob([kml], { type:'application/vnd.google-earth.kml+xml' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url; a.download = `${nomeArq}.kml`;
          document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        });
      });
    }

    // Camadas Hidrografia
    const riosLayer = new L.GeoJSON.AJAX("Rios_.geojson", {
      pane: 'pane-hidros-rios',
      style: (f)=>{ const s = styleRios(f); return s; },
      onEachFeature: (feature, layer)=>{
        layer.options._baseStyle = styleRios(feature);
        hydroPopup(feature, layer, 'rio');
        layer.on({ mouseover: hoverRio, mouseout: resetHoverRio });
        try {
          const nome = nomeHidrografia(feature.properties || {}, 'Rio');
          layer.bindTooltip(nome, { direction:'top', opacity:0.9, sticky:false });
        } catch(_){}
      }
    })
    const massasAguaLayer = new L.GeoJSON.AJAX("Massas_Dagua.geojson", {
      pane: 'pane-hidros-massas',
      style: (f)=>{ const s = styleMassas(f); return s; },
      onEachFeature: (feature, layer)=>{
        layer.options._baseStyle = styleMassas(feature);
        hydroPopup(feature, layer, 'massa');
        layer.on({ mouseover: hoverMassa, mouseout: resetHoverMassa });
        try {
          const nome = nomeHidrografia(feature.properties || {}, "Massa d'√°gua");
          layer.bindTooltip(nome, { direction:'top', opacity:0.9, sticky:false });
        } catch(_){}
      }
    })

/* ==== FERROVIAS: estilo, hover, tooltip e KML ==== */
function getFerroNome(props = {}, fallback = 'Ferrovia') {
  // tenta alguns nomes comuns
  const keys = ['nome','Nome','NOME','linha','Linha','railway','RAILWAY','operador','operador_nome'];
  const hit = keys.find(k => Object.keys(props).some(p => p.toLowerCase() === k.toLowerCase()));
  const v = hit ? props[hit] : '';
  return (v ?? '').toString().trim() || fallback;
}

function styleFerrovia(feature) {
  return {
    pane: 'pane-ferrovias',
    color: '#3a3a3a',     // trilho met√°lico escuro
    weight: 6,            // espessura base
    opacity: 1,
    lineCap: 'round',
    lineJoin: 'round'
  };
}

function hoverFerroEnter(e){
  const l = e.target;
  // realce tipo ‚Äúcasing‚Äù + engrossa
  l.setStyle({ color:'#212121', weight:5, opacity:1, dashArray:'0' });
  try { l.bringToFront(); } catch(_){}
}
function hoverFerroLeave(e){
  const l = e.target;
  if (l.options && l.options._baseStyle) l.setStyle(l.options._baseStyle);
}

function bindFerroPopup(feature, layer){
  const p = feature.properties || {};
  const nome = getFerroNome(p);

  const html = `
    <div style="font-weight:bold;margin-bottom:6px;">Ferrovia ‚Äî ${nome}</div>
    ${buildPropsTableAll(p)}
    <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
      <button class="ferro-kml-btn" style="padding:6px 10px;border:1px solid #ccc;border-radius:6px;background:#fff;cursor:pointer;">Baixar KML</button>
    </div>`;

  layer.bindPopup(html);

  layer.on('popupopen', (e)=>{
    const el = e.popup.getElement();
    const btn = el.querySelector('.ferro-kml-btn');
    if (!btn) return;
    btn.addEventListener('click', ()=>{
      const nomeArq = (nome || 'ferrovia')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^\w\s-]/g,'').replace(/\s+/g,'_');

      let kml = tokml({ type:'FeatureCollection', features:[feature] });
      // estilo KML (linha escura com casing leve)
      const estiloKML = `
        <Style id="ferroStyle">
          <LineStyle><color>ff212121</color><width>4</width></LineStyle>
        </Style>`;
      kml = kml.replace('</Document>', `${estiloKML}</Document>`)
               .replace(/<Placemark>/g, '<Placemark><styleUrl>#ferroStyle</styleUrl>');

      const blob = new Blob([kml], { type:'application/vnd.google-earth.kml+xml' });
      const url  = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `${nomeArq}.kml`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });
  });
}
// === Camada Ferrovias ===
// Coloque o arquivo "ferrovias.geojson" na mesma pasta do HTML
const ferroviasLayer = new L.GeoJSON.AJAX("ferrovias.geojson", {
  pane: 'pane-ferrovias',
  style: (f) => {
    const st = styleFerrovia(f);
    return st;
  },
  onEachFeature: (feature, layer) => {
    // guarda estilo base para restaurar no hover out
    if (layer.setStyle) layer.options._baseStyle = styleFerrovia(feature);

    // popup + hover
    bindFerroPopup(feature, layer);
    layer.on({ mouseover: hoverFerroEnter, mouseout: hoverFerroLeave });
    // Adiciona o ‚Äútrilho duplo‚Äù por cima
try {
  const coords = feature.geometry.coordinates;
  const line = L.polyline(L.GeoJSON.coordsToLatLngs(coords, 0), {
    pane: 'pane-ferrovias',
    color: '#d9d9d9',     // tom met√°lico claro
    weight: 2.5,
    opacity: 1,
    dashArray: '8,8'      // dormentes (espa√ßamento)
  });
  line.addTo(map);
} catch (e) { console.warn('Erro ao desenhar trilho duplo', e); }

    // tooltip com nome
    try {
      const nome = getFerroNome(feature.properties || {}, 'Ferrovia');
      layer.bindTooltip(nome, { direction:'top', opacity:0.9, sticky:false });
    } catch(_){}
  }
});
/* ==== Camadas UCs ==== */
const PATH_UC_FED = 'unidadesdeconservacaofederal.geojson';
const PATH_UC_EST = 'unidadesdeconservacaoestadual.geojson';

const ucFederalLayer = new L.GeoJSON.AJAX(PATH_UC_FED, {
  pane: 'pane-uc-federal',
  style: (f)=> styleUC(f, true),
  onEachFeature: (feature, layer)=>{
    if (layer.setStyle) layer.options._baseStyle = styleUC(feature, true);

    // üî¥ for√ßa o t√≠tulo a usar exatamente o campo NomeUC
    if (feature.properties && feature.properties.NomeUC) {
      feature.properties.nome = feature.properties.NomeUC;
    }

    bindUCPopup(feature, layer, 'UC Federal');
    layer.on({ mouseover: hoverUCEnter, mouseout: hoverUCLeave });
  }
});
const ucEstadualLayer = new L.GeoJSON.AJAX(PATH_UC_EST, {
  pane: 'pane-uc-estadual',
  style: (f)=>{ const st = styleUC(f, false); return st; },
  onEachFeature: (feature, layer)=>{
    if (layer.setStyle) layer.options._baseStyle = styleUC(feature, false);
    bindUCPopup(feature, layer, 'UC Estadual');
    layer.on({ mouseover: hoverUCEnter, mouseout: hoverUCLeave });
  }
});

   // Camada Minera√ß√£o (arquivo no mesmo diret√≥rio: Minera√ß√£o_PI.geojson)
const mineracaoLayer = new L.GeoJSON.AJAX("Minera√ß√£o_PI.geojson", {
  pane: 'pane-mineracao',
  pointToLayer: (feature, latlng) => {
    const st = styleMinerPoint(feature);
    const mk = L.circleMarker(latlng, st);
    mk.options._baseStyle = st; // reset no hoverLeave
    return mk;
  },
  style: (feature) => { // para pol√≠gonos/linhas, se houver
    const st = styleMinerPoly(feature);
    return st;
  },
  onEachFeature: (feature, layer) => {
    if (layer.setStyle) {
      layer.options._baseStyle = styleMinerPoly(feature);
    }
    bindMinerPopup(feature, layer);
    layer.on({ mouseover: hoverMinerEnter, mouseout: hoverMinerLeave });
    try {
      const nome = getEnterpriseName(feature.properties || {});
      const tipo = getMineralType(feature.properties || {});
      const label = nome ? `${nome} ‚Äî ${tipo}` : `${tipo}`;
      layer.bindTooltip(label, { direction:'top', opacity:0.9, sticky:false });
    } catch(_){}
  }
})

// N√ÉO adiciona o mineracaoLayer direto ao mapa.
// Ele servir√° s√≥ para carregar e organizar as fei√ß√µes por tipo.

// === Grupos por tipo de min√©rio ===
const mineralGroups = new Map();     // "tipo" -> L.LayerGroup
const visibleTypes  = new Set();     // conjunto dos tipos vis√≠veis

function getMineralGroup(tipo){
  const key = (tipo || 'Desconhecido').toString();
  if (!mineralGroups.has(key)) {
    const g = L.layerGroup();
    mineralGroups.set(key, g);
    // por padr√£o, tudo come√ßa vis√≠vel
    visibleTypes.add(key);
    // adiciona o grupo ao "raiz" (que est√° no mapa)
    mineracaoRoot.addLayer(g);
  }
  return mineralGroups.get(key);
}

// Move cada fei√ß√£o carregada para o grupo do seu tipo
function wireFeaturesToGroups(){
  mineracaoLayer.eachLayer(l => {
    const p = l?.feature?.properties || {};
    const tipo = getMineralType(p);
    const grp  = getMineralGroup(tipo);
    l._minerTypeKey = tipo;    // <<< guarda o tipo do grupo desta fei√ß√£o
    grp.addLayer(l);
  });
}


mineracaoLayer.on('data:loaded', () => {
  wireFeaturesToGroups();     // organiza por tipo
  addMineralLegend();         // (re)constr√≥i a legenda com checkboxes
});

/* ====== Legenda din√¢mica da Minera√ß√£o (com liga/desliga por tipo) ====== */
let minerLegendCtrl = null;

// Liga/Desliga um tipo
function setTypeVisibility(tipo, visible){
  const key = (tipo || 'Desconhecido').toString();
  const grp = mineralGroups.get(key);
  if (!grp) return;

  if (visible){
    visibleTypes.add(key);
    mineracaoRoot.addLayer(grp);
  } else {
    visibleTypes.delete(key);
    mineracaoRoot.removeLayer(grp);
  }
  applyMinerFilters(); // revalida ap√≥s mudar o tipo
}


function buildMinerLegendHTML() {
  if (!mineralColors.size) return '<i>(sem classes carregadas)</i>';

  const header = `
    <div style="font-weight:bold;text-align:center;margin-bottom:6px;">
      Tipos de Min√©rio
    </div>

    <!-- Filtros -->
    <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:10px;">
      <input id="minerSearchProc" type="text" placeholder="Pesquisar por Processo"
             value="${minerSearchProcVal || ''}"
             style="width:100%;padding:6px 8px;border:1px solid #ccc;border-radius:6px;"/>
      <input id="minerSearchSubs" type="text" placeholder="Filtrar por Subst√¢ncia"
             value="${minerSearchSubsVal || ''}"
             style="width:100%;padding:6px 8px;border:1px solid #ccc;border-radius:6px;"/>
      <div style="display:flex;gap:8px;justify-content:flex-end;">
        <button type="button" id="minerClearFilters"
          style="padding:4px 8px;border:1px solid #ccc;border-radius:6px;background:#fff;cursor:pointer;">
          Limpar filtros
        </button>
      </div>
    </div>

    <!-- A√ß√µes de tipos -->
    <div style="display:flex;justify-content:center;gap:10px;margin-bottom:10px;">
      <button type="button" id="minerCheckAll"
        style="padding:4px 8px;border:1px solid #ccc;border-radius:6px;background:#fff;cursor:pointer;">
        Selecionar tudo
      </button>
      <button type="button" id="minerUncheckAll"
        style="padding:4px 8px;border:1px solid #ccc;border-radius:6px;background:#fff;cursor:pointer;">
        Limpar
      </button>
    </div>`;

  const itens = Array.from(mineralColors.entries())
    .sort((a,b) => a[0].localeCompare(b[0],'pt-BR'))
    .map(([tipo, cor]) => {
      const checked = visibleTypes.has(tipo) ? 'checked' : '';
      const id = `chk_${tipo.replace(/\W+/g,'_')}`;
      return `
        <label for="${id}" style="display:flex;align-items:center;gap:8px;margin:6px 0;cursor:pointer;">
          <input type="checkbox" id="${id}" data-tipo="${tipo}" ${checked} />
          <span style="display:inline-block;width:16px;height:16px;background:${cor};border:1px solid #333;border-radius:3px;"></span>
          <span style="font-size:13px;">${tipo}</span>
        </label>`;
    }).join('');

  return header + itens;
}


function addMineralLegend() {
  if (minerLegendCtrl) {
    const c = minerLegendCtrl.getContainer();
    if (c) {
      c.innerHTML = buildMinerLegendHTML();
      wireLegendEvents(c);
    }
    return;
  }

  minerLegendCtrl = L.control({ position: 'bottomright' });
  minerLegendCtrl.onAdd = function() {
    const div = L.DomUtil.create('div', 'legend-mineracao');
    div.style.background = 'white';
    div.style.lineHeight = '18px';
    div.style.color = '#333';
    div.style.padding = '10px';
    div.style.fontSize = '14px';
    div.style.borderRadius = '6px';
    div.style.maxWidth = '260px';
    div.style.maxHeight = '40vh';
    div.style.overflowY = 'auto';
    div.style.boxShadow = 'var(--shadow)';
    div.innerHTML = buildMinerLegendHTML();

    // ESSENCIAL: permite rolar a legenda sem arrastar o mapa
    L.DomEvent.disableClickPropagation(div);
    L.DomEvent.disableScrollPropagation(div);
    div.addEventListener('wheel',  e => e.stopPropagation(), { passive: false });
    div.addEventListener('touchmove', e => e.stopPropagation(), { passive: false });

    // liga os eventos dos checkboxes/bot√µes
    wireLegendEvents(div);
    return div;
  };
  minerLegendCtrl.addTo(map);
}

// Conecta eventos dos checkboxes e bot√µes Selecionar Tudo/Limpar
function wireLegendEvents(container){
  // Checkboxes de tipos
  container.querySelectorAll('input[type="checkbox"][data-tipo]').forEach(chk => {
    chk.addEventListener('change', (ev) => {
      const tipo = ev.target.getAttribute('data-tipo');
      const visible = ev.target.checked;
      setTypeVisibility(tipo, visible);
    });
  });

  // Selecionar tudo
  const btnAll = container.querySelector('#minerCheckAll');
  if (btnAll){
    btnAll.addEventListener('click', () => {
      mineralGroups.forEach((_grp, tipo) => setTypeVisibility(tipo, true));
      addMineralLegend(); // re-render
    });
  }

  // Limpar (desmarca todos os tipos)
  const btnNone = container.querySelector('#minerUncheckAll');
  if (btnNone){
    btnNone.addEventListener('click', () => {
      mineralGroups.forEach((_grp, tipo) => setTypeVisibility(tipo, false));
      addMineralLegend(); // re-render
    });
  }

  // === NOVO: campos de busca ===
  const inpProc = container.querySelector('#minerSearchProc');
  const inpSubs = container.querySelector('#minerSearchSubs');
  const debouncedApply = debounce(() => {
    minerSearchProcVal = inpProc?.value || '';
    minerSearchSubsVal = inpSubs?.value || '';
    applyMinerFilters();
  }, 200);

  if (inpProc) inpProc.addEventListener('input', debouncedApply);
  if (inpSubs) inpSubs.addEventListener('input', debouncedApply);

  const btnClear = container.querySelector('#minerClearFilters');
  if (btnClear){
    btnClear.addEventListener('click', () => {
      if (inpProc) inpProc.value = '';
      if (inpSubs) inpSubs.value = '';
      minerSearchProcVal = '';
      minerSearchSubsVal = '';
      applyMinerFilters();
    });
  }

  // üîπ Enter desativa todos que n√£o correspondem
  const handleEnter = (ev) => {
    if (ev.key === 'Enter') {
      ev.preventDefault();
      minerSearchProcVal = inpProc?.value || '';
      minerSearchSubsVal = inpSubs?.value || '';

      // Aplica filtros primeiro
      applyMinerFilters();

      // Desativa todos os tipos sem correspond√™ncia
      const foundTypes = new Set();
      mineracaoLayer.eachLayer(l => {
        const p = l.feature?.properties || {};
        const tipo = (l._minerTypeKey || getMineralType(p));
        const proc = getProcessoValue(p);
        const matchSubs = textMatches(tipo, minerSearchSubsVal);
        const matchProc = textMatches(proc, minerSearchProcVal);
        if (matchSubs && matchProc) foundTypes.add(tipo);
      });

      mineralGroups.forEach((_grp, tipo) => {
        setTypeVisibility(tipo, foundTypes.has(tipo));
      });

      // Atualiza a legenda visualmente
      addMineralLegend();
    }
  };

  if (inpProc) inpProc.addEventListener('keydown', handleEnter);
  if (inpSubs) inpSubs.addEventListener('keydown', handleEnter);
}


    // Adiciona Hidrografia ao controle
    layersControl.addOverlay(riosLayer, "Rios");
    layersControl.addOverlay(massasAguaLayer, "Massas d'√°gua");
    layersControl.addOverlay(ferroviasLayer, "Ferrovias");
    layersControl.addOverlay(ucFederalLayer,  "UCs Federais");
    layersControl.addOverlay(ucEstadualLayer, "UCs Estaduais");



// === Fun√ß√£o de estilo para LITOLOGIA ===
function styleLitologiaBySigla(feature) {
  const sigla = feature.properties.SIGLAS_UNID;
  const color = litoFixed.get(sigla) || '#CCCCCC';
  return {
    color: '#000000',     // borda
    weight: 0.5,          // espessura da borda
    fillColor: color,     // cor do interior (da tabela litoFixed)
    fillOpacity: 1,     // <<< ajuste a opacidade aqui
    opacity: 1       // <<< e aqui, se quiser tamb√©m reduzir a borda
  };
}


/* === Camada LITOLOGIA (classificada por SIGLAS_UNID) === */
const litologiaLayer = new L.GeoJSON.AJAX("litologia.geojson", {
  pane: 'pane-litologia',
  style: (f) => { const st = styleLitologiaBySigla(f); return st; },
  onEachFeature: (feature, layer) => {
    if (layer.setStyle) layer.options._baseStyle = styleLitologiaBySigla(feature);
    bindLitologiaPopup(feature, layer);
    layer.on({ mouseover: hoverLitoEnter, mouseout: hoverLitoLeave });
    try {
      const lbl = getSiglaUnid(feature.properties || {});
      layer.bindTooltip(lbl, { direction:'top', opacity:0.9, sticky:false });
    } catch(_){}
  }
});
// n√£o adiciona direto no mapa (inicia DESLIGADA)
layersControl.addOverlay(litologiaLayer, "Litologia (SIGLAS_UNID)");




  // Grupo-raiz para todos os tipos de minera√ß√£o (liga/desliga geral)
const mineracaoRoot = L.layerGroup().addTo(map);
layersControl.addOverlay(mineracaoRoot, "Minera√ß√£o");

    // Envelopar painel de camadas
    map.whenReady(()=>{
      const panel = document.querySelector('.leaflet-control-layers');
      if (panel) {
        panel.classList.add('collapsed-panel');
        const wrapper = document.createElement('div');
        wrapper.id = 'camadasWrapper';
        const header = document.createElement('div');
        header.id = 'camadasHeader';
        header.innerText = 'Visualizar Camadas';
        header.addEventListener('click', ()=> panel.classList.toggle('collapsed-panel'));
        wrapper.appendChild(header);
        wrapper.appendChild(panel);
        document.body.appendChild(wrapper);
      }
    });

    function recolherCamadas() {
      const panel = document.querySelector('.leaflet-control-layers');
      if (panel && !panel.classList.contains('collapsed-panel')) {
        panel.classList.add('collapsed-panel');
      }
    }
    (function ativarFechamentoCamadas(){
      const onBodyClick = (e) => {
        const wrapper = document.getElementById('camadasWrapper');
        const panel = document.querySelector('.leaflet-control-layers');
        if (!wrapper || !panel) return;
        const aberto = !panel.classList.contains('collapsed-panel');
        if (!aberto || wrapper.contains(e.target)) return;
        recolherCamadas();
      };
      const onEsc = (e) => { if (e.key === 'Escape') recolherCamadas(); };
      const bloquearDentro = () => {
        const wrapper = document.getElementById('camadasWrapper');
        if (!wrapper) return;
        wrapper.addEventListener('click', e => e.stopPropagation());
        wrapper.addEventListener('touchstart', e => e.stopPropagation(), {passive:true});
      };
      document.addEventListener('click', onBodyClick);
      document.addEventListener('touchstart', onBodyClick, {passive:true});
      document.addEventListener('keydown', onEsc);
      if (document.getElementById('camadasWrapper')) bloquearDentro();
      else {
        const obs = new MutationObserver(() => {
          if (document.getElementById('camadasWrapper')) { bloquearDentro(); obs.disconnect(); }
        });
        obs.observe(document.body, {childList:true, subtree:true});
      }
    })();
    
/* ==== MINERA√á√ÉO: classifica√ß√£o, popup e hover ==== */
// ===== BUSCA NA LEGENDA (estado + helpers) =====
let minerSearchProcVal = '';
let minerSearchSubsVal = '';

function getProcessoValue(props = {}){
  return pickProp(props, [
    'processo','proc','processo_dnpm','processo_anm',
    'n_processo','n√∫mero','numero','nup','num'
  ]);
}
function textMatches(value, query){
  if (!query) return true;
  const v = (value ?? '').toString().toLowerCase();
  return v.includes(query.toLowerCase());
}
function debounce(fn, wait=250){
  let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); };
}
function applyMinerFilters(){
  const qProc = (minerSearchProcVal || '').trim().toLowerCase();
  const qSubs = (minerSearchSubsVal || '').trim().toLowerCase();

  mineracaoLayer.eachLayer(l => {
    const p    = l?.feature?.properties || {};
    const tipo = (l._minerTypeKey || getMineralType(p) || '').toString();
    const proc = getProcessoValue(p) || '';

    const typeVisible = visibleTypes.has(tipo);
    const matchSubs   = textMatches(tipo, qSubs);
    const matchProc   = textMatches(proc, qProc);
    const pass        = typeVisible && matchSubs && matchProc;

    const grp = mineralGroups.get(tipo);
    if (!grp) return;

    if (pass){
      if (!grp.hasLayer(l)) grp.addLayer(l);
    } else {
      if (grp.hasLayer(l)) grp.removeLayer(l);
    }
  });
}

// Paleta para classes (vai ciclando se tiver muitas)
const minerioPalette = [
  '#1b9e77','#d95f02','#7570b3','#e7298a',
  '#66a61e','#e6ab02','#a6761d','#666666',
  '#1f78b4','#b2df8a','#fdbf6f','#cab2d6'
];

// mapa din√¢mico "tipo ‚Üí cor"
const mineralColors = new Map();
let mineralColorIndex = 0;

// helper: Title Case com suporte a acentos (pt-BR)
function toTitleCasePt(str){
  return String(str)
    .toLocaleLowerCase('pt-BR')
    // cada sequ√™ncia de letras (inclui acentos) vira "Primeira Mai√∫scula + resto min√∫sculo"
    .replace(/\p{L}+/gu, w => {
      const first = w[0].toLocaleUpperCase('pt-BR');
      const rest  = w.slice(1); // j√° est√° min√∫sculo pelo toLocaleLowerCase acima
      return first + rest;
    });
}

function getMineralType(props = {}) {
  // tolera varia√ß√µes: SUBS / Subs / SOBS
  let raw = props.SOBS ?? props.Subs ?? props.SUBS;
  if (raw == null) return 'Desconhecido';

  raw = String(raw).trim();
  if (!raw) return 'Desconhecido';

  // pega a primeira subst√¢ncia quando vier separado por / , ;
  const first = raw.split(/[\/,;]+/)[0].trim();

  // aplica Title Case correto (√Ågua, Ouro, Ferro, etc.)
  const tipo = toTitleCasePt(first);

  return tipo || 'Desconhecido';
}



// tenta pegar um "nome/empresa" para tooltip
function getEnterpriseName(props = {}) {
  const candidates = [
    'empresa','nome','razao_social','razao','razaosocial','titular',
    'EMPRESA','NOME','RAZAO_SOCIAL','TITULAR'
  ];
  const hit = candidates.find(k => Object.keys(props).some(p => p.toLowerCase() === k.toLowerCase()));
  return hit ? (props[hit] || '').toString() : '';
}

// define/recupera cor para um tipo
function colorForMineral(tipo) {
  const key = (tipo || 'Desconhecido').toString();
  if (!mineralColors.has(key)) {
    mineralColors.set(key, minerioPalette[mineralColorIndex % minerioPalette.length]);
    mineralColorIndex++;
  }
  return mineralColors.get(key);
}

// estilo p/ pontos (circleMarker)
function styleMinerPoint(feature) {
  const tipo = getMineralType(feature.properties);
  const cor  = colorForMineral(tipo);
  return {
    pane: 'pane-mineracao',
    radius: 6,
    color: '#222',
    weight: 1.5,
    fillColor: cor,
    fillOpacity: 0.85
  };
}

// estilo p/ pol√≠gonos/linhas (se houver)
function styleMinerPoly(feature) {
  const tipo = getMineralType(feature.properties);
  const cor  = colorForMineral(tipo);
  return {
    pane: 'pane-mineracao',
    color: cor,
    weight: 2.2,
    fillColor: cor,
    fillOpacity: 0.35
  };
}

// ====== HELPERS PADR√ÉO TABELA ======
function pickProp(props, keys) {
  for (const k of keys) {
    const hit = Object.keys(props).find(p => p.toLowerCase() === String(k).toLowerCase());
    if (hit && props[hit] != null && String(props[hit]).trim() !== '') return props[hit];
  }
  return null;
}

function formatAreaHa(v) {
  const n = Number(v);
  if (!Number.isFinite(n)) return String(v ?? '-');
  return n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatDateBr(v) {
  if (!v) return '-';
  // tenta ISO/aaaa-mm-dd, timestamp, etc.
  const d = new Date(v);
  if (!isNaN(d.getTime())) {
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yyyy = d.getFullYear();
    return `${dd}/${mm}/${yyyy}`;
  }
  // tenta dd/mm/aaaa j√° pronto
  const m = String(v).match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if (m) {
    const dd = m[1].padStart(2,'0'), mm = m[2].padStart(2,'0');
    const yyyy = m[3].length === 2 ? ('20'+m[3]) : m[3];
    return `${dd}/${mm}/${yyyy}`;
  }
  return String(v);
}

// ====== SUBSTITUA SUA bindMinerPopup POR ESTA ======
function bindMinerPopup(feature, layer) {
  const p = feature.properties || {};
  const tipo = getMineralType(p); // j√° corrige "√Ågua", etc.

  // Mapeamento: cada r√≥tulo ‚Üí poss√≠veis chaves na sua base
  const FIELD_MAP = [
    { label: 'Processo',       keys: ['processo','proc','processo_dnpm','processo_anm'] },
    { label: 'N√∫mero',         keys: ['numero','n√∫mero','n_processo','nup','num'] },
    { label: 'Ano',            keys: ['ano','year'] },
    { label: 'Fase',           keys: ['fase','situacao','situa√ß√£o','status'] },
    { label: 'Titular',        keys: ['titular','empresa','razao_social','raz√£o_social','nome'] },
    // Subst√¢ncia ser√° calculada, mas tamb√©m tentamos pegar o bruto se houver
    { label: 'Subst√¢ncia',     keys: ['subs','sobs','substancia','subst√¢ncia'] },
    { label: 'Uso',            keys: ['uso','finalidade','aplicacao','aplica√ß√£o'] },
    { label: '√Årea (ha)',      keys: ['area_ha','√°rea_ha','area','√°rea','ha'] },
    { label: 'UF',             keys: ['uf','estado'] },
    { label: '√öltimo evento',  keys: ['ultimo_evento','√∫ltimo_evento','ult_evento','data_evento','data_ultimo_evento'] },
    { label: 'ID',             keys: ['id','codigo','c√≥digo','cod'] },
  ];

  const rows = [];

  for (const f of FIELD_MAP) {
    let val = pickProp(p, f.keys);

    // P√≥s-processamentos por campo
    if (f.label === 'Subst√¢ncia') {
      // Preferimos o tipo normalizado; se n√£o existir nada bruto, usamos o tipo
      val = tipo || val || '-';
    } else if (f.label === '√Årea (ha)') {
      if (val == null && p.area_m2) {
        // fallback: se vier em m¬≤, converte para ha
        const ha = Number(p.area_m2) / 10000;
        val = ha;
      }
      val = formatAreaHa(val);
    } else if (f.label === 'UF') {
      val = (val == null) ? '-' : String(val).toUpperCase();
    } else if (f.label === '√öltimo evento') {
      val = formatDateBr(val);
    } else if (val == null || String(val).trim() === '') {
      val = '-';
    }

    rows.push(
      `<tr>
        <th style="text-align:left;padding:6px 8px;border-bottom:1px solid #ddd;font-weight:bold;">${f.label}</th>
        <td style="text-align:right;padding:6px 8px;border-bottom:1px solid #ddd;">${val}</td>
       </tr>`
    );
  }

  const html = `
    <div style="font-weight:bold;margin-bottom:6px;">Minera√ß√£o ‚Äî ${tipo || '-'}</div>
    <table style="border-collapse:collapse;width:100%;font-size:.95em;">
      ${rows.join('')}
    </table>
    <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
      <button class="miner-kml-btn" style="padding:6px 10px;border:1px solid #ccc;border-radius:6px;background:#fff;cursor:pointer;">Baixar KML</button>
    </div>`;

  layer.bindPopup(html);

  layer.on('popupopen', (e) => {
    const el = e.popup.getElement();
    const btn = el.querySelector('.miner-kml-btn');
    if (!btn) return;
    btn.addEventListener('click', () => {
      const nomeArqBase = (getEnterpriseName(p) || tipo || 'mineracao')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^\w\s-]/g,'').replace(/\s+/g,'_');
      let kml = tokml({ type:'FeatureCollection', features:[feature] });
      const estiloKML = `
        <Style id="minerStyle">
          <IconStyle>
            <Icon><href>http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png</href></Icon>
          </IconStyle>
          <LineStyle><color>ff333333</color><width>2</width></LineStyle>
          <PolyStyle><color>80999999</color><fill>1</fill><outline>1</outline></PolyStyle>
        </Style>`;
      kml = kml.replace('</Document>', `${estiloKML}</Document>`)
               .replace(/<Placemark>/g, '<Placemark><styleUrl>#minerStyle</styleUrl>');
      const blob = new Blob([kml], { type:'application/vnd.google-earth.kml+xml' });
      const url  = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `${nomeArqBase}.kml`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
  });
}

/* ===== LITOLOGIA: SIGLAS_UNID (cores por sigla) + popup de todos os atributos ===== */
const litoPalette = [
  '#8dd3c7', '#ffffb3', '#bebada', '#fb8072', '#80b1d3', '#fdb462',
  '#b3de69', '#fccde5', '#d9d9d9', '#bc80bd', '#ccebc5', '#ffed6f'
];
// (opcional) mapa de cores fixas para algumas siglas conhecidas; edite √† vontade
const litoFixed = new Map([
   ['A23bf', '#F5C4C8'],
  ['A23cb', '#819000'],
  ['A23gm', '#FBE8DE'],
  ['A23gs', '#E9BDBB'],
  ['A23iu', '#486321'],
  ['A23j2', '#CC5B5B'],
  ['A24_gamma_g', '#EFC2D3'],
  ['A24d', '#F5C4C8'],
  ['A24g', '#8898BA'],
  ['A2PP2gc', '#FB9898'],
  ['A2_gamma_pm', '#CAA0A1'],
  ['A2bj', '#B900A0'],
  ['A2cf', '#33803D'],
  ['A2gf', '#F8C2C2'],
  ['A2j1', '#CC5B5B'],
  ['A2ja', '#C5982E'],
  ['A2jr', '#FDA600'],
  ['A2js', '#9E5900'],
  ['A2mk', '#89A41A'],
  ['A2mn', '#336F32'],
  ['A2msl', '#F8C2C2'],
  ['A2p', '#F4C3C9'],
  ['A34am', '#C4BBAD'],
  ['A34atg', '#F5C4C8'],
  ['A34ie', '#E7C3D4'],
  ['A34jpa', '#F5DDE8'],
  ['A34jq', '#FEB800'],
  ['A34p', '#F9DBDB'],
  ['A34r', '#E8CF00'],
  ['A34s', '#E4AECC'],
  ['A3PP3j', '#F5C4C8'],
  ['A3_beta_cd', '#698415'],
  ['A3_beta_d', '#95AF2C'],
  ['A3_beta_rv', '#7CA83B'],
  ['A3_beta_sa', '#AFC65D'],
  ['A3_delta_g', '#00FFFF'],
  ['A3_delta_l', '#035800'],
  ['A3_gamma_1cbg', '#FB7171'],
  ['A3_gamma_1gr', '#F97070'],
  ['A3_gamma_1mt', '#FB7171'],
  ['A3_gamma_ch', '#9F9AFD'],
  ['A3_gamma_es', '#D05275'],
  ['A3_gamma_gt', '#FEA4A4'],
  ['A3_gamma_iaf', '#F38FFC'],
  ['A3_gamma_mo', '#F395FE'],
  ['A3_gamma_mp', '#DF0000'],
  ['A3_gamma_ms', '#F6A4FE'],
  ['A3_gamma_nc', '#C03640'],
  ['A3_gamma_rm', '#F7C2FE'],
  ['A3_gamma_tl', '#F3A4FD'],
  ['A3_gamma_xg', '#FEC2C2'],
  ['A3_mu_sa', '#ADA4FE'],
  ['A3_teta_ca', '#3D5900'],
  ['A3_teta_cf', '#3A460A'],
  ['A3_teta_ml', '#405208'],
  ['A3_teta_sc', '#364305'],
  ['A3ai', '#678302'],
  ['A3av', '#EA5CB9'],
  ['A3b', '#F4C3C9'],
  ['A3ba', '#D2FE66'],
  ['A3bh', '#F4C3C9'],
  ['A3bo', '#89A41A'],
  ['A3br', '#D05275'],
  ['A3ca', '#819000'],
  ['A3cac', '#D98CA2'],
  ['A3cb', '#7F8928'],
  ['A3cbs', '#FB7171'],
  ['A3cc', '#EB9CAE'],
  ['A3cca', '#FEDCDC'],
  ['A3cg', '#F5C4C8'],
  ['A3ci', '#547200'],
  ['A3co', '#FEC2C2'],
  ['A3cpt', '#B4DFB3'],
  ['A3cto', '#EB9CAE'],
  ['A3fmv', '#BFD898'],
  ['A3gmb', '#FDDFE0'],
  ['A3go', '#F5C4C8'],
  ['A3gr', '#B4FD00'],
  ['A3is', '#B58AA8'],
  ['A3la', '#F5C4C8'],
  ['A3lc', '#E39E8D'],
  ['A3li1', '#CAA88C'],
  ['A3li2', '#9F826B'],
  ['A3lm', '#FBDDDD'],
  ['A3lp', '#F0B4BE'],
  ['A3lq', '#EA9D8E'],
  ['A3ls', '#03FE00'],
  ['A3lsb', '#F0CCAD'],
  ['A3mp', '#00FEAA'],
  ['A3phg', '#808570'],
  ['A3po', '#F7B6B3'],
  ['A3qx', '#B4FE00'],
  ['A3ra', '#A4BB45'],
  ['A3s', '#DA73D8'],
  ['A3sa', '#02DB00'],
  ['A3sb', '#F5C4C8'],
  ['A3smo', '#657038'],
  ['A3sp', '#5F7A0A'],
  ['A3ssr1', '#FEBE7F'],
  ['A3ssr2', '#FE9D7F'],
  ['A3st', '#74762E'],
  ['A3tm', '#F6C5C8'],
  ['A3tu', '#DCD5AC'],
  ['A3u', '#FDADAD'],
  ['A3ua', '#F8DBDF'],
  ['A3xi', '#F6DFF9'],
  ['A4PP1_mu_g', '#016300'],
  ['A4PP1cm', '#C6B64E'],
  ['A4PP1mc', '#D7B09E'],
  ['A4PP1mic', '#CD6666'],
  ['A4PP1nv', '#F3D964'],
  ['A4PP2t', '#D5A6AF'],
  ['A4PP3_mu_j', '#67272A'],
  ['A4PPr', '#BC5C82'],
  ['A4_delta_pi', '#FE7C7C'],
  ['A4_delta_si', '#00DAFE'],
  ['A4_gamma_2', '#96498C'],
  ['A4_gamma_2cr', '#FEA4A4'],
  ['A4_gamma_2e', '#FF0000'],
  ['A4_gamma_2ge', '#FD9595'],
  ['A4_gamma_2pl', '#FF00FF'],
  ['A4_gamma_2pq', '#F6A4FE'],
  ['A4_gamma_2sr', '#FD7D38'],
  ['A4_gamma_jc', '#DF7ABA'],
  ['A4_gamma_ml', '#FA97BA'],
  ['A4_gamma_ms', '#FA97BA'],
  ['A4_gamma_mv', '#FA97BA'],
  ['A4_mu_c', '#016113'],
  ['A4_mu_ca', '#00D5DA'],
  ['A4_mu_l', '#ADA4FE'],
  ['A4_mu_lg', '#00D0DB'],
  ['A4an', '#C4C6D9'],
  ['A4aq', '#68FDCF'],
  ['A4ar', '#C7CCFF'],
  ['A4bm', '#FCDEDE'],
  ['A4bv', '#6F9169'],
  ['A4cc', '#9A94DC'],
  ['A4cm', '#C488A7'],
  ['A4cmo', '#9FBEC9'],
  ['A4co', '#E7C8D7'],
  ['A4cpb', '#AAA9A9'],
  ['A4cr', '#E6A6C7'],
  ['A4gnl', '#D257F5'],
  ['A4gu', '#FCC4C4'],
  ['A4h', '#EBBAC5'],
  ['A4ib', '#83AB87'],
  ['A4ii', '#C5B3BE'],
  ['A4ij', '#BABB28'],
  ['A4ir', '#ACD0AB'],
  ['A4is', '#B7DF86'],
  ['A4it1', '#C7B74E'],
  ['A4it2', '#D8CC56'],
  ['A4jg', '#CED2FB'],
  ['A4ji', '#C2A8B3'],
  ['A4lm', '#BAB728'],
  ['A4ln', '#90940B'],
  ['A4mgd', '#EA8AA2'],
  ['A4mgr', '#E8A4B8'],
  ['A4mt', '#E9B2C1'],
  ['A4mtn', '#EAD5DA'],
  ['A4pa', '#FFD2EB'],
  ['A4pp', '#A7FEA4'],
  ['A4rm', '#EDDB95'],
  ['A4rma', '#D8CB78'],
  ['A4rnl', '#BC903D'],
  ['A4rp', '#846BED'],
  ['A4ru', '#9C7F7D'],
  ['A4sb', '#9F7401'],
  ['A4scg', '#938FBB'],
  ['A4scm', '#A3A0BB'],
  ['A4se', '#E89ABC'],
  ['A4sf', '#8EAB65'],
  ['A4sj', '#198F8F'],
  ['A4sn', '#8781BC'],
  ['A4so', '#C6984A'],
  ['A4ss', '#BCDB3B'],
  ['A4tar', '#C49749'],
  ['A4tb', '#AC8D69'],
  ['A4tbo', '#AEA8A4'],
  ['A4td', '#AE9888'],
  ['A4ti', '#C6BDAE'],
  ['A4ts', '#C5C0B9'],
  ['A4ua', '#FFBEE8'],
  ['A4ur', '#9A6201'],
  ['A4vsrc', '#399605'],
  ['APP_beta', '#99A501'],
  ['APP_gamma_i', '#FEC2C2'],
  ['APP_mu', '#348346'],
  ['APPcs', '#CC981D'],
  ['APPi', '#FDCFC1'],
  ['APPitt2', '#E5AFCC'],
  ['APPmu', '#348446'],
  ['APPn', '#FDEBE0'],
  ['APPng', '#E600E8'],
  ['APPnv', '#FED7C2'],
  ['APPsb', '#A5AC8B'],
  ['APPsu1', '#00FEAA'],
  ['APPsu2', '#E4FDB2'],
  ['Ajp', '#B48AA8'],
  ['C1f', '#BDA660'],
  ['C1ja', '#C5C791'],
  ['C1po', '#C4CA93'],
  ['C2P1a', '#92B9B2'],
  ['C2P1i', '#8DA8B6'],
  ['C2P1t', '#99ABB5'],
  ['C2bb', '#73B5CF'],
  ['C2cm', '#BECFD9'],
  ['C2i', '#C4C992'],
  ['C2ma', '#BAB978'],
  ['C2no', '#C9E0E4'],
  ['C2pi', '#C0C0C0'],
  ['CKip', '#C89342'],
  ['CPi', '#E9E2DE'],
  ['CPii', '#A9A067'],
  ['CPsf', '#69B5D7'],
  ['C_cortado_12_gamma_4i', '#E72944'],
  ['C_cortado_12_gamma_4p1', '#FD0000'],
  ['C_cortado_12_gamma_4p2', '#FD0000'],
  ['C_cortado_1_delta_cc', '#00FEA5'],
  ['C_cortado_1_gamma_4ab', '#FC0000'],
  ['C_cortado_1_gamma_m', '#FF4000'],
  ['C_cortado_1_gamma_m1', '#FF4000'],
  ['C_cortado_1_gamma_m2', '#FF4000'],
  ['C_cortado_1_gamma_snn', '#FE0000'],
  ['C_cortado_1_mu_ma', '#EDE28A'],
  ['C_cortado_1m', '#FD4068'],
  ['C_cortado_2_gamma_4b', '#E72944'],
  ['C_cortado_2_gamma_5supb', '#A60000'],
  ['C_cortado_2_gamma_5supt', '#FD8164'],
  ['C_cortado_2_gamma_i', '#FE0000'],
  ['C_cortado_3_alfa_m', '#FD6500'],
  ['C_cortado_3_gamma_4pa', '#E72944'],
  ['C_cortado_3_gamma_co', '#E81433'],
  ['C_cortado_3_gamma_v', '#FA3D53'],
  ['C_cortado_4O1_gamma_6nfmb', '#FF6C6C'],
  ['C_cortado_Oja', '#EBAE44'],
  ['C_cortado_Ojua', '#630000'],
  ['C_cortado_Ojuc', '#B2877A'],
  ['C_cortado_Orjat', '#E89800'],
  ['C_cortado_Orjco', '#D98E00'],
  ['C_cortado_Orjm', '#B38303'],
  ['C_cortado_a_delta_4', '#868400'],
  ['C_cortado_a_delta_4bm', '#4EFCBF'],
  ['C_cortado_a_gamma_3Igc', '#FD9999'],
  ['C_cortado_a_gamma_4Cpp', '#DF65A4'],
  ['C_cortado_a_gamma_4Iva', '#FA5367'],
  ['C_cortado_a_gamma_4Sta', '#F88383'],
  ['C_cortado_a_gamma_4Sv', '#FC7272'],
  ['C_cortado_a_gamma_4gs', '#E479A3'],
  ['C_cortado_delta_5essb', '#7FAD51'],
  ['C_cortado_gamma_3Sab', '#FA88D0'],
  ['C_cortado_gamma_3Sabo', '#BE597A'],
  ['C_cortado_gamma_4a', '#BE597A'],
  ['C_cortado_gamma_4s', '#FB7171'],
  ['C_cortado_gamma_5Isamc', '#F9536A'],
  ['C_cortado_gamma_5ammd', '#FB678D'],
  ['C_cortado_i', '#B76B00'],
  ['C_cortado_jmp', '#A87000'],
  ['C_cortado_jp', '#8B7815'],
  ['C_cortado_jpc', '#FFAA00'],
  ['C_cortado_tu', '#828778'],
  ['Cc', '#BECFD9'],
  ['D1f', '#DD9100'],
  ['D1j', '#E5BD7A'],
  ['D23c', '#E5B685'],
  ['D23p', '#CBDF85'],
  ['D2e', '#D8B3A5'],
  ['D2ml', '#B09449'],
  ['D3C1c', '#BCA760'],
  ['D3C1l', '#D78300'],
  ['D3C1o', '#E4BAA5'],
  ['D3b', '#E3AF5E'],
  ['D3c', '#FDB785'],
  ['Dc', '#938A5A'],
  ['Di', '#E5BBA6'],
  ['Dpg', '#E6B460'],
  ['E1N1ac', '#FABC84'],
  ['E1_gamma_sb', '#FE7FC3'],
  ['E3N1g', '#F6E5B2'],
  ['E3N1t', '#FEE5BC'],
  ['E3_beta_m', '#51F3A3'],
  ['ENb', '#FDCF00'],
  ['ENbc', '#FFF212'],
  ['ENch', '#FBEAC9'],
  ['ENdi', '#F7D162'],
  ['ENdl', '#FECF19'],
  ['ENfa', '#F7D162'],
  ['ENfp', '#FAAC70'],
  ['ENj', '#F5D061'],
  ['ENsm', '#FEEA6D'],
  ['ENst', '#E8E5B1'],
  ['ENtp', '#DBCD00'],
  ['Ec', '#FEEA6D'],
  ['Edlg', '#D89F76'],
  ['Elm', '#E69800'],
  ['Em', '#A8A8A8'],
  ['Esp', '#FDD591'],
  ['J1_beta_t', '#02BE31'],
  ['J2pb', '#69BB68'],
  ['J3K1_beta_ap', '#00DA2D'],
  ['J3K1c', '#50A94B'],
  ['J3K1g', '#58B7D9'],
  ['J3K1sg', '#46CB83'],
  ['J3K1sgb', '#90CADF'],
  ['J3a', '#53BF66'],
  ['J3ai', '#7FC481'],
  ['J3ap', '#4EBF67'],
  ['J3at', '#62C77A'],
  ['J3b', '#46CB83'],
  ['J3bg', '#58B7D9'],
  ['J3bj', '#3CA866'],
  ['J3br', '#8BD79E'],
  ['J3bs', '#8DC38E'],
  ['J3bv', '#48A96A'],
  ['J3c', '#9FD9AD'],
  ['J3cl', '#78C489'],
  ['J3cv', '#8BD79E'],
  ['J3e', '#66C185'],
  ['J3fa', '#A0D3C3'],
  ['J3fp', '#8DC4A4'],
  ['J3g', '#4DBA72'],
  ['J3i', '#50A94B'],
  ['J3it', '#76C087'],
  ['J3iv', '#7FCA94'],
  ['J3j', '#60C282'],
  ['J3jb', '#66CC8C'],
  ['J3ji', '#77D09A'],
  ['J3jo', '#72C589'],
  ['J3jr', '#58B977'],
  ['J3l', '#5CC489'],
  ['J3la', '#56B883'],
  ['J3lb', '#60C282'],
  ['J3lc', '#66C589'],
  ['J3le', '#7ACC93'],
  ['J3li', '#8BD79E'],
  ['J3lm', '#4BB973'],
  ['J3lp', '#67C48D'],
  ['J3lt', '#73CB93'],
  ['J3m', '#83D0A3'],
  ['J3mb', '#71C28B'],
  ['J3mc', '#67C48D'],
  ['J3ml', '#7CCB96'],
  ['J3n', '#8ED8A5'],
  ['J3nl', '#7CCB96'],
  ['J3np', '#68BF85'],
  ['J3o', '#59B97B'],
  ['J3p', '#8ED8A5'],
  ['J3pa', '#5FC282'],
  ['J3pi', '#50B777'],
  ['J3pm', '#79C996'],
  ['J3pn', '#61C384'],
  ['J3pp', '#71CC90'],
  ['J3pq', '#68C285'],
  ['J3pt', '#8FD8A5'],
  ['J3q', '#7CCB96'],
  ['J3r', '#6FC189'],
  ['J3ra', '#7ACB93'],
  ['J3rb', '#65C185'],
  ['J3rc', '#58B97A'],
  ['J3re', '#72C28B'],
  ['J3rf', '#66BF86'],
  ['J3rg', '#7CCB96'],
  ['J3rh', '#8ED8A5'],
  ['J3ri', '#6DC389'],
  ['J3rj', '#58B977'],
  ['J3rk', '#67C48D'],
  ['J3rm', '#70CA91'],
  ['J3rn', '#8AD7A3'],
  ['J3ro', '#6FC189'],
  ['J3rp', '#7FCF98'],
  ['J3rq', '#5BC07F'],
  ['J3rr', '#73CB93'],
  ['J3rs', '#60C282'],
  ['J3rt', '#72C58B'],
  ['J3ru', '#64C285'],
  ['J3rv', '#59B97A'],
  ['J3rw', '#7ACB93'],
  ['J3rx', '#8ED8A5'],
  ['J3ry', '#70C68C'],
  ['J3rz', '#8AD7A3'],
  ['J3s', '#72C58B'],
  ['J3sa', '#6FC189'],
  ['J3sb', '#8ED8A5'],
  ['J3sc', '#68C285'],
  ['J3sd', '#5FC282'],
  ['J3se', '#8FD8A5'],
  ['J3sf', '#59B97A'],
  ['J3sg', '#70C68C'],
  ['J3sh', '#73CB93'],
  ['J3si', '#8BD79E'],
  ['J3sj', '#66C589'],
  ['J3sk', '#67C48D'],
  ['J3sl', '#7ACB93'],
  ['J3sm', '#8AD7A3'],
  ['J3sn', '#72C28B'],
  ['J3so', '#64C285'],
  ['J3sp', '#59B97A'],
  ['J3sq', '#8ED8A5'],
  ['J3sr', '#5FC282'],
  ['J3ss', '#70C68C'],
  ['J3st', '#8FD8A5'],
  ['J3su', '#8BD79E'],
  ['J3sv', '#67C48D'],
  ['J3sw', '#72C58B'],
  ['J3sx', '#59B97A'],
  ['J3sy', '#8ED8A5'],
  ['J3sz', '#64C285'],
  ['J3ta', '#70C68C'],
  ['J3tb', '#7FCF98'],
  ['J3tc', '#73CB93'],
  ['J3td', '#8AD7A3'],
  ['J3te', '#8FD8A5'],
  ['J3tf', '#6FC189'],
  ['J3tg', '#7ACB93'],
  ['J3th', '#59B97A'],
  ['J3ti', '#8BD79E'],
  ['J3tj', '#66C589'],
  ['J3tk', '#67C48D'],
  ['J3tl', '#70C68C'],
  ['J3tm', '#8ED8A5'],
  ['J3tn', '#5FC282'],
  ['J3to', '#59B97A'],
  ['J3tp', '#8FD8A5'],
  ['J3tq', '#73CB93'],
  ['J3tr', '#7FCF98'],
  ['J3ts', '#8AD7A3'],
  ['J3tt', '#72C58B'],
  ['J3tu', '#67C48D'],
  ['J3tv', '#8ED8A5'],
  ['J3tw', '#59B97A'],
  ['J3tx', '#70C68C'],
  ['J3ty', '#8FD8A5'],
  ['J3tz', '#7ACB93'],
  ['J3ua', '#8BD79E'],
  ['J3ub', '#72C28B'],
  ['J3uc', '#6FC189'],
  ['J3ud', '#59B97A'],
  ['J3ue', '#8AD7A3'],
  ['J3uf', '#5FC282'],
  ['J3ug', '#70C68C'],
  ['J3uh', '#8FD8A5'],
  ['J3ui', '#67C48D'],
  ['J3uj', '#8BD79E'],
  ['J3uk', '#73CB93'],
  ['J3ul', '#7ACB93'],
  ['J3um', '#8AD7A3'],
  ['J3un', '#59B97A'],
  ['J3uo', '#70C68C'],
  ['J3up', '#8FD8A5'],
  ['J3uq', '#72C58B'],
  ['J3ur', '#67C48D'],
  ['J3us', '#8ED8A5'],
  ['J3ut', '#8BD79E'],
  ['J3uu', '#7ACB93'],
  ['J3uv', '#59B97A'],
  ['J3uw', '#70C68C'],
  ['J3ux', '#8FD8A5'],
  ['J3uy', '#73CB93'],
  ['J3uz', '#8AD7A3'],
  ['J3va', '#8ED8A5'],
  ['J3vb', '#67C48D'],
  ['J3vc', '#72C58B'],
  ['J3vd', '#59B97A'],
  ['J3ve', '#8BD79E'],
  ['J3vf', '#6FC189'],
  ['J3vg', '#70C68C'],
  ['J3vh', '#8FD8A5'],
  ['J3vi', '#8AD7A3'],
  ['J3vj', '#5FC282'],
  ['J3vk', '#67C48D'],
  ['J3vl', '#73CB93'],
  ['J3vm', '#8ED8A5'],
  ['J3vn', '#7ACB93'],
  ['J3vo', '#8BD79E'],
  ['J3vp', '#59B97A'],
  ['J3vq', '#70C68C'],
  ['J3vr', '#8FD8A5'],
  ['J3vs', '#72C58B'],
  ['J3vt', '#8AD7A3'],
  ['J3vu', '#67C48D'],
  ['J3vv', '#8ED8A5'],
  ['J3vw', '#7ACB93'],
  ['J3vx', '#8BD79E'],
  ['J3vy', '#73CB93'],
  ['J3vz', '#8AD7A3'],
  ['J3wa', '#59B97A'],
  ['J3wb', '#70C68C'],
  ['J3wc', '#8FD8A5'],
  ['J3wd', '#72C58B'],
  ['J3we', '#67C48D'],
  ['J3wf', '#8ED8A5'],
  ['J3wg', '#8BD79E'],
  ['J3wh', '#7ACB93'],
  ['J3wi', '#73CB93'],
  ['J3wj', '#8AD7A3'],
  ['J3wk', '#70C68C'],
  ['J3wl', '#8FD8A5'],
  ['J3wm', '#8ED8A5'],
  ['J3wn', '#59B97A'],
  ['J3wo', '#72C58B'],
  ['J3wp', '#8BD79E'],
  ['J3wq', '#8AD7A3'],
  ['J3wr', '#70C68C'],
  ['J3ws', '#8FD8A5'],
  ['J3wt', '#67C48D'],
  ['J3wu', '#7ACB93'],
  ['J3wv', '#73CB93'],
  ['J3ww', '#8ED8A5'],
  ['J3wx', '#59B97A'],
  ['J3wy', '#8BD79E'],
  ['J3wz', '#8FD8A5'],
  ['J3xa', '#70C68C'],
  ['J3xb', '#72C58B'],
  ['J3xc', '#67C48D'],
  ['J3xd', '#8ED8A5'],
  ['J3xe', '#8AD7A3'],
  ['J3xf', '#73CB93'],
  ['J3xg', '#8BD79E'],
  ['J3xh', '#59B97A'],
  ['J3xi', '#7ACB93'],
  ['J3xj', '#8FD8A5'],
  ['J3xk', '#8ED8A5'],
  ['J3xl', '#70C68C'],
  ['J3xm', '#8AD7A3'],
  ['J3xn', '#73CB93'],
  ['J3xo', '#67C48D'],
  ['J3xp', '#8BD79E'],
  ['J3xq', '#8FD8A5'],
  ['J3xr', '#59B97A'],
  ['J3xs', '#70C68C'],
  ['J3xt', '#72C58B'],
  ['J3xu', '#8ED8A5'],
  ['J3xv', '#8AD7A3'],
  ['J3xw', '#8BD79E'],
  ['J3xx', '#67C48D'],
  ['J3xy', '#8FD8A5'],
  ['J3xz', '#73CB93'],
  ['J4a', '#A7D8A9'],
  ['J4b', '#7FC481'],
  ['J4c', '#6ABF77'],
  ['J4d', '#50A94B'],
  ['J4e', '#66C185'],
  ['J4f', '#8BD79E'],
  ['J4g', '#72C28B'],
  ['J4h', '#70C68C'],
  ['J4i', '#5FC282'],
  ['J4j', '#67C48D'],
  ['J4k', '#8FD8A5'],
  ['J4l', '#73CB93'],
  ['J4m', '#7ACB93'],
  ['J4n', '#8AD7A3'],
  ['J4o', '#8ED8A5'],
  ['J4p', '#59B97A'],
  ['J4q', '#8BD79E'],
  ['J4r', '#67C48D'],
  ['J4s', '#70C68C'],
  ['J4t', '#8FD8A5'],
  ['J4u', '#72C58B'],
  ['J4v', '#73CB93'],
  ['J4w', '#7FCF98'],
  ['J4x', '#8ED8A5'],
  ['J4y', '#59B97A'],
  ['J4z', '#8AD7A3'],
  ['K1a', '#96B691'],
  ['K1b', '#C2DBBF'],
  ['K1c', '#8FFF7F'],
  ['K1d', '#6BBF6A'],
  ['K1e', '#4FB04E'],
  ['K1f', '#73B273'],
  ['K1g', '#AEDDAC'],
  ['K1h', '#BEDFE4'],
  ['K1i', '#94C597'],
  ['K1j', '#2D8955'],
  ['K1k', '#4AD58D'],
  ['K1l', '#73DA9E'],
  ['K1m', '#C3DDC1'],
  ['K1n', '#A7B8A5'],
  ['K1o', '#82F2BB'],
  ['K1p', '#A8D9A4'],
  ['K1q', '#6C7A6B'],
  ['K1r', '#D7F4D5'],
  ['K1s', '#46CB83'],
  ['K1t', '#DFFDDD'],
  ['K1u', '#8ACF8A'],
  ['K1v', '#C3DDC1'],
  ['K1x', '#94C597'],
  ['K1z', '#C8FEC6'],
  ['K2a', '#C6DA9B'],
  ['K2b', '#A9EDC7'],
  ['K2c', '#C6DA9B'],
  ['K2d', '#79E491'],
  ['K2e', '#D6C899'],
  ['K2f', '#99F8B0'],
  ['K2g', '#FEEA6D'],
  ['K2h', '#00D3D8'],
  ['K2i', '#C2DCC0'],
  ['K2j', '#C6DA9B'],
  ['K2k', '#A2E3BE'],
  ['K2l', '#C8EED9'],
  ['K2m', '#79D379'],
  ['K2n', '#C4D694'],
  ['K2p', '#C7D89A'],
  ['K2q', '#97C69D'],
  ['K2r', '#91DB99'],
  ['K2s', '#9DB975'],
  ['K2t', '#C4FEC2'],
  ['K2u', '#C4D694'],
  ['K2v', '#84D799'],
  ['K2x', '#AECB07'],
  ['K2z', '#F1EB9D'],
  ['MP1a', '#2B7942'],
  ['MP1b', '#D63B3B'],
  ['MP1c', '#E665F5'],
  ['MP1d', '#7ACD00'],
  ['MP1e', '#C8C2FE'],
  ['MP1f', '#A13D3D'],
  ['MP1g', '#FD9CA0'],
  ['MP1h', '#59DB00'],
  ['MP1i', '#E1BEBE'],
  ['MP1j', '#87C49D'],
  ['MP1k', '#822B34'],
  ['MP1l', '#BA8689'],
  ['MP1m', '#AF805A'],
  ['MP1n', '#A5A899'],
  ['MP1o', '#9CC8C3'],
  ['MP1p', '#A89D99'],
  ['MP1q', '#D38D6F'],
  ['MP1r', '#CCA46C'],
  ['MP1s', '#02AD00'],
  ['MP1t', '#00AB00'],
  ['MP1u', '#D6CBA7'],
  ['MP1v', '#7191B0'],
  ['MP1w', '#B09F91'],
  ['MP1x', '#B28F72'],
  ['MP1y', '#59DB00'],
  ['MP2a', '#A4E700'],
  ['MP2b', '#9FE800'],
  ['MP2c', '#039F26'],
  ['MP2d', '#60E000'],
  ['MP2e', '#4F9E61'],
  ['MP2f', '#016300'],
  ['MP2g', '#DD7C7C'],
  ['MP2h', '#FE6D0A'],
  ['MP2i', '#9DBD0A'],
  ['MP2j', '#00E5CF'],
  ['MP2k', '#E63600'],
  ['MP2l', '#FEB4D0'],
  ['MP2m', '#FE888B'],
  ['MP2n', '#E83072'],
  ['MP2o', '#DB6B6F'],
  ['MP2p', '#E78578'],
  ['MP2q', '#E45A5A'],
  ['MP2r', '#FE8D8D'],
  ['MP2s', '#F33D3D'],
  ['MP2t', '#E78181'],
  ['MP2u', '#7ACD00'],
  ['MP2v', '#7ACD00'],
  ['MP2x', '#C3F9FE'],
  ['MP2y', '#80CF94'],
  ['MP2z', '#7FAD51'],
  ['MP3a', '#60DF00'],
  ['MP3b', '#02BB30'],
  ['MP3c', '#A9E600'],
  ['MP3d', '#54BAA9'],
  ['MP3e', '#42BA65'],
  ['MP3f', '#009C11'],
  ['MP3g', '#FEA4AD'],
  ['MP3h', '#FD6993'],
  ['MP3i', '#FD6D5E'],
  ['MP3j', '#FAA2B5'],
  ['MP3k', '#AF3688'],
  ['MP3l', '#FB979E'],
  ['MP3m', '#FC9494'],
  ['MP3n', '#B8A39B'],
  ['MP3o', '#B38574'],
  ['MP3p', '#FCBCBF'],
  ['MP3q', '#FE8B8E'],
  ['MP3r', '#B17C6C'],
  ['MP3s', '#A8824A'],
  ['MP3t', '#756574'],
  ['MP3u', '#E4BABA'],
  ['MP3v', '#2DADCA'],
  ['MP3w', '#00A784'],
  ['MP3x', '#FFB700'],
  ['MP3y', '#FCDA51'],
  ['MP3z', '#92AE2F'],
  ['MPa1', '#944547'],
  ['MPa2', '#9F6230'],
  ['MPa3', '#E18234'],
  ['MPa4', '#CDA300'],
  ['MPa5', '#D9C700'],
  ['MPb', '#BE8456'],
  ['MPbt', '#D2A78E'],
  ['MPbv', '#D89872'],
  ['MPcm', '#B29379'],
  ['MPg', '#91D5F0'],
  ['MPma', '#7FC5FE'],
  ['MPmd', '#FDC5AB'],
  ['MPpa1', '#F2D2C3'],
  ['MPpa2', '#F7D0BD'],
  ['MPpa3', '#DDBEAF'],
  ['MPpa4', '#CAA592'],
  ['MPpa4mm', '#FECFB8'],
  ['MPpv', '#95F6FE'],
  ['MPsac', '#72ABCA'],
  ['MPsap', '#C9A1A6'],
  ['MPsapc', '#81A9AC'],
  ['NP1a', '#56AC85'],
  ['NP1b', '#DF8084'],
  ['NP1c', '#B48573'],
  ['NP1d', '#B58573'],
  ['NP1e', '#FCCAE0'],
  ['NP1f', '#98E600'],
  ['NP1g', '#CCAB8B'],
  ['NP1h', '#FD4FB9'],
  ['NP1i', '#00C700'],
  ['NP1j', '#A8A800'],
  ['NP1k', '#E046AB'],
  ['NP1l', '#F988D2'],
  ['NP1m', '#037500'],
  ['NP1n', '#40C23E'],
  ['NP1o', '#BDB59F'],
  ['NP1p', '#DBD1B8'],
  ['NP1q', '#B8B4A9'],
  ['NP1r', '#86C7C1'],
  ['NP1s', '#B6A0A4'],
  ['NP1t', '#547C78'],
  ['NP1u', '#C7BEAF'],
  ['NP1v', '#BEA8C2'],
  ['NP1w', '#9EB1D0'],
  ['NP1x', '#B7ADA8'],
  ['NP1y', '#DBA8C2'],
  ['NP1z', '#C9BCA5'],
  ['NP2a', '#A192B9'],
  ['NP2b', '#708FBA'],
  ['NP2c', '#B2A4B2'],
  ['NP2d', '#E9E2FC'],
  ['NP2e', '#DBCEEE'],
  ['NP2f', '#BABABA'],
  ['NP2g', '#656565'],
  ['NP2h', '#BE9A7E'],
  ['NP2i', '#8A9ED1'],
  ['NP2j', '#BBD1E8'],
  ['NP2k', '#A5B58F'],
  ['NP2l', '#D4CBC7'],
  ['NP2m', '#99EB80'],
  ['NP2n', '#B5E0A7'],
  ['NP2o', '#D09F77'],
  ['NP2p', '#97C6CA'],
  ['NP2q', '#747400'],
  ['NP2r', '#9CAB87'],
  ['NP2s', '#D4B299'],
  ['NP2t', '#A59BB3'],
  ['NP2u', '#D0B9A2'],
  ['NP2v', '#62CDDF'],
  ['NP2w', '#C8C4EA'],
  ['NP2x', '#E1D5FD'],
  ['NP2y', '#C4B7CB'],
  ['NP2z', '#F9C2FE'],
]);
const litoColors = new Map();
let litoIdx = 0;

function getSiglaUnid(props = {}) {
  const candidates = [
    'SIGLA_UNID',          // ‚úÖ este √© o que est√° no seu arquivo
    'SIGLAS_UNID','Siglas_Unid','siglas_unid',
    'SIGLA','sigla','UNID','Unid','unid','UNIDADE','unidade'
  ];
  const hit = candidates.find(k => Object.keys(props).some(p => p.toLowerCase() === k.toLowerCase()));
  const v = hit ? props[hit] : '';
  const s = (v ?? '').toString().trim();
  return s || 'Sem sigla';
}
function colorForSigla(sigla) {
  const key = String(sigla);
  if (litoFixed.has(key)) return litoFixed.get(key);
  if (!litoColors.has(key)) {
    litoColors.set(key, litoPalette[litoIdx % litoPalette.length]);
    litoIdx++;
  }
  return litoColors.get(key);
}
function styleLitologiaBySigla(feature) {
  const sigla = getSiglaUnid(feature.properties || {});
  const cor   = colorForSigla(sigla);
  return { pane:'pane-litologia', color: cor, weight: 1.2, fillColor: cor, fillOpacity: 0.45 };
}
// hover
function hoverLitoEnter(e){ const l=e.target; l.setStyle({weight:2.8, fillOpacity:0.65}); try{l.bringToFront();}catch(_){}} 
function hoverLitoLeave(e){ const l=e.target; if(l.options && l.options._baseStyle) l.setStyle(l.options._baseStyle); }

// tabela completa (todos os campos)
function buildPropsTableAll(props = {}) {
  const keys = Object.keys(props).sort((a,b)=>a.localeCompare(b,'pt-BR'));
  const rows = keys.map(k => {
    let v = props[k];
    if (typeof v === 'number') v = v.toLocaleString('pt-BR');
    if (v != null && v !== '') v = repairMojibake(v);  // <<< corrige mojibake
    if (v == null || v === '') v = '-';
    return `<tr>
      <th style="text-align:left;padding:6px 8px;border-bottom:1px solid #ddd;">${k}</th>
      <td style="text-align:right;padding:6px 8px;border-bottom:1px solid #ddd;">${v}</td>
    </tr>`;
  }).join('');
  return `<table style="border-collapse:collapse;width:100%;font-size:.95em;">${rows || '<tr><td>(Sem atributos)</td></tr>'}</table>`;
}


// popup
function bindLitologiaPopup(feature, layer) {
  const p = feature.properties || {};
  const sigla = getSiglaUnid(p);
  const html = `
    <div style="font-weight:bold;margin-bottom:6px;">Litologia ‚Äî ${sigla}</div>
    ${buildPropsTableAll(p)}
    <div style="display:flex; gap:8px; margin-top:8px;">
      <button class="lito-kml-btn" style="padding:6px 10px;border:1px solid #ccc;border-radius:6px;background:#fff;cursor:pointer;">Baixar KML</button>
    </div>`;
  layer.bindPopup(html);

  layer.on('popupopen', ev => {
    const el = ev.popup.getElement();
    const btn = el.querySelector('.lito-kml-btn');
    if (!btn) return;
    btn.addEventListener('click', () => {
      const nome = (sigla || 'litologia')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^\w\s-]/g,'').replace(/\s+/g,'_');
      let kml = tokml({ type:'FeatureCollection', features:[feature] });
      const styleKML = `
        <Style id="litoStyle">
          <LineStyle><color>ff333333</color><width>2</width></LineStyle>
          <PolyStyle><color>80999999</color><fill>1</fill><outline>1</outline></PolyStyle>
        </Style>`;
      kml = kml.replace('</Document>', `${styleKML}</Document>`)
               .replace(/<Placemark>/g, '<Placemark><styleUrl>#litoStyle</styleUrl>');
      const blob = new Blob([kml], { type:'application/vnd.google-earth.kml+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `${nome}.kml`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
  });
}



// efeitos de hover
function hoverMinerEnter(e) {
  const l = e.target;
  if (l instanceof L.CircleMarker) {
    l.setStyle({ radius: 9, weight: 2.5 });
  } else {
    l.setStyle({ weight: 4, fillOpacity: 0.55 });
  }
  try { l.bringToFront(); } catch(_){}
}
function hoverMinerLeave(e) {
  const l = e.target;
  if (l.options && l.options._baseStyle) l.setStyle(l.options._baseStyle);
}









    /* === Legenda de Territ√≥rios === */
    function addLegend() {
      if (!territorioColors.length && territoriosLayer) {
        territoriosLayer.eachLayer(l => {
          const p = l.feature?.properties || {};
          getColorForTerritorio(p.NM_TD || 'Territ√≥rio', p.fid || '');
        });
      }
      document.querySelectorAll('.legend, .legend-toggle').forEach(el => el.remove());

      const toggleBtn = document.createElement('button');
      toggleBtn.className = 'legend-toggle attention';
      toggleBtn.textContent = 'Selecionar  territ√≥rios';

      const legendDiv = document.createElement('div');
      legendDiv.className = 'legend collapsed';
      legendDiv.innerHTML = '<div style="text-align:center;font-weight:bold;margin-bottom:5px;">Territ√≥rios de Desenvolvimento</div>';

      territorioColors.slice().sort((a,b)=>(a.codigo||0)-(b.codigo||0)).forEach(t => {
        const item = document.createElement('div');
        item.className = 'territorio-item';
        item.dataset.nome = t.nome;
        item.style.cssText = 'cursor:pointer;display:flex;align-items:center;gap:6px;margin-bottom:6px;';
        item.innerHTML = `<i style="background:${t.cor};width:24px;height:24px;display:inline-block;"></i>
                          <span style="font-size:13px;">${t.label}</span>`;
        item.addEventListener('click', () => highlightTerritory(t.nome));
        legendDiv.appendChild(item);
      });

      toggleBtn.addEventListener('click', () => {
        legendDiv.classList.toggle('collapsed');
        toggleBtn.textContent = legendDiv.classList.contains('collapsed') ? 'Selecionar  territ√≥rios' : 'Ocultar territ√≥rios';
        toggleBtn.classList.remove('attention');
      });

      document.body.appendChild(toggleBtn);
      document.body.appendChild(legendDiv);
    }
    function highlightTerritory(nome) {
      territoriosLayer.eachLayer(layer => {
        if (!layer.feature) return;
        const nt = layer.feature.properties.NM_TD;
        const ct = layer.feature.properties.fid;
        if (nt === nome) {
          const cor = getColorForTerritorio(nt, ct);
          layer.setStyle({ color: cor, weight: 3, fillColor: cor, fillOpacity: 0.8 });
          map.fitBounds(layer.getBounds());
        } else {
          layer.setStyle({ color:"#222", weight:1, fillColor:"#222", fillOpacity:0.8 });
        }
      });
      municipiosLayer.eachLayer(mLayer => {
        mLayer.off("mouseover", highlightFeature);
        mLayer.off("mouseout", resetHighlight);
        mLayer.on({ mouseover: highlightFeature, mouseout: resetHighlight });
      });
      document.querySelectorAll('.territorio-item').forEach(item=>{
        item.style.fontWeight = (item.getAttribute('data-nome')===nome)?"bold":"normal";
        item.style.color = (item.getAttribute('data-nome')===nome)?"#000":"";
      });
    }

    /* Lat/Lon -> UTM + coordenadas */
    function latLonToUTM(lat, lon) {
      const a=6378137,f=1/298.257223563,k0=0.9996,e=Math.sqrt(f*(2-f));
      const zone=Math.floor((lon+180)/6)+1, l0=(zone-1)*6-180+3, l0r=l0*Math.PI/180;
      const p=lat*Math.PI/180, l=lon*Math.PI/180;
      const N=a/Math.sqrt(1-e*e*Math.sin(p)*Math.sin(p)), T=Math.tan(p)*Math.tan(p), C=(e*e/(1-e*e))*Math.cos(p)*Math.cos(p), A=Math.cos(p)*(l-l0r);
      const M=a*((1-e*e/4-3*e**4/64-5*e**6/256)*p-(3*e*e/8+3*e**4/32+45*e**6/1024)*Math.sin(2*p)+(15*e**4/256+45*e**6/1024)*Math.sin(4*p)-(35*e**6/3072)*Math.sin(6*p));
      const x=k0*N*(A+(1-T+C)*A**3/6+(5-18*T+T*T+72*C-58*(e*e/(1-e*e)))*A**5/120)+500000;
      let y=k0*(M+N*Math.tan(p)*(A**2/2+(5-T+9*C+4*C**2)*A**4/24+(61-58*T+T*T+600*C-330*(e*e/(1-e*e)))*A**6/720));
      if(lat<0) y+=10000000;
      return { x, y, zone };
    }
    const coordsDiv = document.getElementById('coords');
    map.on('mousemove', e=>{
      const lat=e.latlng.lat.toFixed(5), lon=e.latlng.lng.toFixed(5);
      const utm=latLonToUTM(e.latlng.lat,e.latlng.lng);
      coordsDiv.innerHTML = `Lat: ${lat}, Lon: ${lon}<br>E: ${utm.x.toFixed(2)}, N: ${utm.y.toFixed(2)}<br>Fuso: ${utm.zone}`;
    });

    /* Upload KML/KMZ */
    const uploadBtnEl=document.getElementById('uploadBtn');
    const uploadInputEl=document.getElementById('uploadInput');
    uploadBtnEl.addEventListener('click', ()=>uploadInputEl.click());
    uploadInputEl.addEventListener('change', async (e)=>{
      const files=[...e.target.files];
      for (const file of files){
        const name=file.name;
        try{
          if(name.toLowerCase().endsWith('.kml')){
            const text=await file.text(); addKMLTextToMap(text,name);
          } else if(name.toLowerCase().endsWith('.kmz')){
            const arrayBuf=await file.arrayBuffer(); const zip=await JSZip.loadAsync(arrayBuf);
            let kmlEntry=null; zip.forEach((relPath,zipEntry)=>{ if(!kmlEntry && relPath.toLowerCase().endsWith('.kml')) kmlEntry=zipEntry; });
            if(!kmlEntry){ alert('KMZ sem arquivo KML interno: '+name); continue; }
            const kmlText=await kmlEntry.async('text'); addKMLTextToMap(kmlText,name);
          } else { alert('Formato n√£o suportado: '+name); }
        } catch(err){ console.error(err); alert('Erro ao carregar '+name+': '+err.message); }
      }
      uploadInputEl.value='';
    });
    function addKMLTextToMap(kmlText, layerName){
      const alvo = L.geoJSON(null, { pane: 'pane-upload' });
      const kmlLayer = omnivore.kml.parse(kmlText, null, alvo).addTo(map);
      if (kmlLayer.bringToFront) kmlLayer.bringToFront();
      if (layersControl) layersControl.addOverlay(kmlLayer, layerName);
      try { map.fitBounds(kmlLayer.getBounds()); } catch (_) {}
    }

    /* Rosa dos Ventos */
    const rosaSBG = L.control({ position: "bottomleft" });
    rosaSBG.onAdd = function () {
      const div = L.DomUtil.create("div", "rosa-sbg");
      div.innerHTML = `
        <svg width="140" height="140" viewBox="0 0 140 140" xmlns="http://www.w3.org/2000/svg">
          <polygon points="70,40 90,80 50,80" fill="black" />
          <text x="70" y="30" font-size="36" font-weight="bold" fill="black" stroke="black" stroke-width="1" text-anchor="middle" dominant-baseline="middle">N</text>
        </svg>`;
      return div;
    };
    rosaSBG.addTo(map);

    /* Estado do Piau√≠ + Biomas recortados */
    fetch("piaui.geojson").then(r=>r.json()).then(piauiData=>{
      const piauiLayer = L.geoJSON(piauiData,{ pane: 'pane-piaui', style:{ color:'yellow', weight:3, fillColor:'transparent', fillOpacity:0 }, onEachFeature:(f,l)=>l.bindPopup("Estado do Piau√≠") }).addTo(map);
      piauiLayer.bringToBack();
      layersControl.addOverlay(piauiLayer,"Estado do Piau√≠");

      const worldBounds = turf.bboxPolygon([-90,-60,-25,15]);
      const mask = turf.difference(worldBounds, piauiData.features[0]);
      L.geoJSON(mask,{ pane: 'pane-mask', style:{ fillColor:'black', fillOpacity:0.5, color:'black', weight:0 }, interactive:false }).addTo(map);

      function styleBiomas(feature){
        const bioma=(feature.properties.Bioma||feature.properties.bioma||"").toLowerCase();
        switch(bioma){
          case "amaz√¥nia": case "amazonia": return { color:"#1B5E20", fillColor:"#1B5E20", fillOpacity:0.5, weight:1 };
          case "caatinga": return { color:"#E6B800", fillColor:"#E6B800", fillOpacity:0.5, weight:1 };
          case "cerrado": return { color:"#4CAF50", fillColor:"#4CAF50", fillOpacity:0.5, weight:1 };
          case "mata atl√¢ntica": case "mata atlantica": return { color:"#00695C", fillColor:"#00695C", fillOpacity:0.5, weight:1 };
          case "pantanal": return { color:"#8D6E63", fillColor:"#8D6E63", fillOpacity:0.5, weight:1 };
          case "pampa": return { color:"#A1887F", fillColor:"#A1887F", fillOpacity:0.5, weight:1 };
          default: return { color:"#9E9E9E", fillColor:"#9E9E9E", fillOpacity:0.5, weight:1 };
        }
      }

      fetch("biomas.geojson").then(r=>r.json()).then(biomasData=>{
        const biomasRecortados={ type:"FeatureCollection", features:[] };
        biomasData.features.forEach(f=>{
          try{
            const inter=turf.intersect(f, piauiData.features[0]);
            if(inter){ inter.properties=f.properties; biomasRecortados.features.push(inter); }
          }catch(e){ console.warn("Erro ao recortar bioma:", e); }
        });
        const biomasLayer = L.geoJSON(biomasRecortados,{ pane: 'pane-biomas', style: styleBiomas, onEachFeature: (feature, layer)=>layer.bindPopup(`<b>Bioma:</b> ${feature.properties.Bioma||feature.properties.bioma||"Bioma"}`) });
        layersControl.addOverlay(biomasLayer, "Biomas");
      });
    });

    /* ESC limpa sele√ß√£o e recolhe busca */
    document.addEventListener('keydown', e=>{
      if (e.key==="Escape") {
        territorioSelecionado=null;
        territoriosLayer.eachLayer(layer=>territoriosLayer.resetStyle(layer));
        const sc = document.getElementById('searchContainer');
        const si = document.getElementById('searchMunicipio');
        const lm = document.getElementById('listaMunicipios');
        if (sc.classList.contains('expanded')) {
          sc.classList.remove('expanded');
          si.value = '';
          lm.style.display='none';
        }
      }
    });

    // Ajuste de bounds inicial
  setTimeout(()=>{
  const group = new L.featureGroup([territoriosLayer, municipiosLayer]);
  try { 
    map.fitBounds(group.getBounds(), { padding:[20,20] }); 
    // trava o zoom m√≠nimo no valor atual
    map.setMinZoom(map.getZoom());
  } catch(_) {}
}, 800);
    // Resize handler
    function ajustarMapa(){ document.getElementById('map').style.height=window.innerHeight+'px'; }
    window.addEventListener('resize', ajustarMapa);
    window.addEventListener('orientationchange', ajustarMapa);
    ajustarMapa();

    // Busca expans√≠vel + clique fora
    (()=>{
      const sc = document.getElementById('searchContainer');
      const st = document.getElementById('searchToggle');
      const si = document.getElementById('searchMunicipio');
      const lm = document.getElementById('listaMunicipios');
      st.addEventListener('click', ()=>{
        sc.classList.toggle('expanded');
        if (sc.classList.contains('expanded')) si.focus();
        else { si.value=''; lm.style.display='none'; }
      });
      document.addEventListener('click', (e)=>{
        if (!sc.contains(e.target) && sc.classList.contains('expanded')) {
          sc.classList.remove('expanded');
          si.value=''; lm.style.display='none';
        }
      });
    })();

    /* Busca Fuzzy */
    let highlightedIndex = -1;
    function levenshtein(a,b){
      const m=[]; for(let i=0;i<=b.length;i++){m[i]=[i]} for(let j=0;j<=a.length;j++){m[0][j]=j}
      for(let i=1;i<=b.length;i++){ for(let j=1;j<=a.length;j++){
        m[i][j]=(b.charAt(i-1)===a.charAt(j-1))?m[i-1][j-1]:Math.min(m[i-1][j-1]+1, Math.min(m[i][j-1]+1, m[i-1][j]+1))
      }}
      return m[b.length][a.length]
    }
    function updateHighlight(itens){
      itens.forEach((item,idx)=>{
        if(idx===highlightedIndex){ item.classList.add('highlighted'); item.scrollIntoView({block:'nearest'}); }
        else item.classList.remove('highlighted');
      });
    }
    const si = document.getElementById('searchMunicipio');
    const lm = document.getElementById('listaMunicipios');
    si.addEventListener('input', function(){
      const termo = this.value.trim().toLowerCase();
      lm.innerHTML = ''; highlightedIndex = -1;
      if(!termo){ lm.style.display = 'none'; return; }
      const resultados = [];
      municipiosLayer.eachLayer(layer=>{
        const nomeMun = layer.feature?.properties?.NM_MUN;
        if(!nomeMun) return;
        const nomeLower = nomeMun.toLowerCase();
        if (nomeLower.includes(termo)) resultados.push({nome:nomeMun, layer});
        else if (levenshtein(termo, nomeLower) <= 3) resultados.push({nome:nomeMun, layer});
      });
      if(!resultados.length){ lm.style.display='none'; return; }
      resultados.sort((a,b)=>a.nome.localeCompare(b.nome,'pt-BR'));
      resultados.forEach(item=>{
        const div = document.createElement('div');
        div.textContent = item.nome;
        div.addEventListener('click', ()=>{
          map.fitBounds(item.layer.getBounds(), { padding:[20,20] });
          if (municipioSelecionado) municipiosLayer.resetStyle(municipioSelecionado);
          municipioSelecionado = item.layer;
          item.layer.setStyle({ weight:4, color:'#ff6600', fillColor:'#ff6600', fillOpacity:0.5 });
          item.layer.closePopup();
          lm.style.display = 'none';
          si.value = item.nome;
          recolherLegenda();
        });
        lm.appendChild(div);
      });
      lm.style.display = 'block';
    });
    si.addEventListener('keydown', (e)=>{
      const itens = lm.querySelectorAll('div');
      if (e.key === 'ArrowDown'){ e.preventDefault(); if (highlightedIndex < itens.length - 1){ highlightedIndex++; updateHighlight(itens); } }
      else if (e.key === 'ArrowUp'){ e.preventDefault(); if (highlightedIndex > 0){ highlightedIndex--; updateHighlight(itens); } }
      else if (e.key === 'Enter'){ e.preventDefault(); if (highlightedIndex >= 0 && highlightedIndex < itens.length){ itens[highlightedIndex].click(); } else { lm.style.display = 'none'; } }
    });
    function recolherLegenda() {
      const legendDiv = document.querySelector('.legend');
      const toggleBtn = document.querySelector('.legend-toggle');
      if (legendDiv && toggleBtn) {
        legendDiv.classList.add('collapsed');
        toggleBtn.textContent = 'Selecionar  territ√≥rios';
        toggleBtn.classList.remove('attention');
      }
    }
  </script>

  <div id="creditosLegenda">
    Coordena√ß√£o de Cartografia e An√°lise Espacial<br>
    CCAE/GEID/DEAE/CIET/SEPLAN
  </div>
</body>
</html>
